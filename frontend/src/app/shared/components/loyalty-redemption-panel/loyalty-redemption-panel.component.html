@if (loading()) {
  <p-card styleClass="mb-3">
    <div class="flex align-items-center gap-3">
      <i class="pi pi-spin pi-spinner text-xl"></i>
      <span>Loading loyalty information...</span>
    </div>
  </p-card>
} @else if (!isEnabled()) {
  <!-- Loyalty program is disabled -->
} @else if (!isEnrolled()) {
  <p-card styleClass="mb-3">
    <div class="flex align-items-center justify-content-between">
      <div class="flex align-items-center gap-3">
        <i class="pi pi-gift text-2xl text-color-secondary"></i>
        <div>
          <span class="font-medium block">Join our Loyalty Program</span>
          <span class="text-color-secondary text-sm">Earn points on every purchase</span>
        </div>
      </div>
      <p-button
        label="Enroll Customer"
        icon="pi pi-user-plus"
        severity="secondary"
        [outlined]="true"
        (onClick)="enrollCustomer.emit()"
      />
    </div>
  </p-card>
} @else {
  <p-card styleClass="mb-3">
    <ng-template pTemplate="header">
      <div class="p-3 pb-0 flex align-items-center justify-content-between">
        <div class="flex align-items-center gap-2">
          <i class="pi pi-ticket text-xl text-primary"></i>
          <span class="font-bold">Loyalty Points</span>
        </div>
        @if (earnedResult()) {
          <p-tag
            [value]="earnedResult()!.tierLabel"
            [severity]="getTierSeverity(earnedResult()!.tier)"
          />
        }
      </div>
    </ng-template>

    <div class="flex flex-column gap-4">
      <!-- Current Balance & Points to Earn -->
      <div class="grid">
        <div class="col-6">
          <div class="surface-100 border-round p-3 text-center">
            <span class="text-color-secondary block mb-1 text-sm">Current Balance</span>
            <span class="text-2xl font-bold text-primary">
              {{ earnedResult()?.currentBalance || 0 | number }}
            </span>
            <span class="text-color-secondary text-sm"> pts</span>
          </div>
        </div>
        <div class="col-6">
          <div class="surface-100 border-round p-3 text-center">
            <span class="text-color-secondary block mb-1 text-sm">Points to Earn</span>
            <span class="text-2xl font-bold text-green-500">
              +{{ earnedResult()?.pointsToEarn || 0 | number }}
            </span>
            <span class="text-color-secondary text-sm"> pts</span>
          </div>
        </div>
      </div>

      @if (earnedResult()?.multiplier && earnedResult()!.multiplier > 1) {
        <p-message
          severity="success"
          [text]="earnedResult()!.tierLabel + ' tier bonus: ' + earnedResult()!.multiplier + 'x points!'"
          styleClass="w-full"
        />
      }

      <!-- Redemption Section -->
      @if (redeemableResult() && redeemableResult()!.maxRedeemablePoints > 0) {
        <p-divider />

        <div>
          <div class="flex align-items-center justify-content-between mb-3">
            <span class="font-medium">Redeem Points</span>
            <span class="text-color-secondary text-sm">
              Max: {{ redeemableResult()!.maxRedeemablePoints | number }} pts
              ({{ redeemableResult()!.maxDiscountValue | currency }})
            </span>
          </div>

          @if (useSlider) {
            <p-slider
              [(ngModel)]="pointsToRedeem"
              [min]="0"
              [max]="redeemableResult()!.maxRedeemablePoints"
              [step]="redeemableResult()!.minPointsToRedeem"
              (onChange)="onPointsChange()"
              styleClass="w-full"
            />
            <div class="flex justify-content-between mt-2 text-sm">
              <span>0</span>
              <span>{{ redeemableResult()!.maxRedeemablePoints | number }}</span>
            </div>
          } @else {
            <p-inputNumber
              [(ngModel)]="pointsToRedeem"
              [min]="0"
              [max]="redeemableResult()!.maxRedeemablePoints"
              [step]="redeemableResult()!.minPointsToRedeem"
              (ngModelChange)="onPointsChange()"
              inputStyleClass="w-full"
              placeholder="Enter points to redeem"
            />
          }

          @if (redemptionPreview()) {
            <div class="mt-3 surface-100 border-round p-3">
              <div class="flex justify-content-between mb-2">
                <span>Points to Redeem:</span>
                <span class="font-medium">{{ redemptionPreview()!.pointsToRedeem | number }}</span>
              </div>
              <div class="flex justify-content-between mb-2 text-green-500">
                <span>Discount:</span>
                <span class="font-bold">-{{ redemptionPreview()!.discountValue | currency }}</span>
              </div>
              <div class="flex justify-content-between text-color-secondary">
                <span>Remaining Balance:</span>
                <span>{{ redemptionPreview()!.remainingBalance | number }} pts</span>
              </div>
            </div>
          }

          <div class="flex gap-2 mt-3">
            <p-button
              label="Redeem Max"
              icon="pi pi-bolt"
              severity="secondary"
              [outlined]="true"
              size="small"
              (onClick)="redeemMax()"
            />
            <p-button
              label="Clear"
              icon="pi pi-times"
              severity="secondary"
              [text]="true"
              size="small"
              [disabled]="!pointsToRedeem"
              (onClick)="clearRedemption()"
            />
          </div>
        </div>
      } @else if (redeemableResult()?.reason) {
        <p-message
          severity="info"
          [text]="redeemableResult()!.reason!"
          styleClass="w-full"
        />
      }
    </div>
  </p-card>
}
