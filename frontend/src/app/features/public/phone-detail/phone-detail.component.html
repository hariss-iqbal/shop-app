<div class="phone-detail-container">
  <!-- Back to Catalog Link -->
  <div class="mb-4">
    <p-button
      icon="pi pi-arrow-left"
      label="Back to Catalog"
      [text]="true"
      (onClick)="goBackToCatalog()"
      ariaLabel="Go back to phone catalog"
    />
  </div>

  @if (loading()) {
    <!-- Loading Skeleton - Enhanced -->
    <div class="grid">
      <div class="col-12 lg:col-7" aria-busy="true" aria-label="Loading phone images">
        <p-skeleton height="500px" styleClass="mb-3 border-round-xl" />
        <div class="flex gap-2">
          <p-skeleton width="100px" height="75px" styleClass="border-round" />
          <p-skeleton width="100px" height="75px" styleClass="border-round" />
          <p-skeleton width="100px" height="75px" styleClass="border-round" />
          <p-skeleton width="100px" height="75px" styleClass="border-round" />
        </div>
      </div>
      <div class="col-12 lg:col-5" aria-busy="true" aria-label="Loading phone details">
        <p-skeleton width="40%" height="1.5rem" styleClass="mb-2" />
        <p-skeleton width="80%" height="2.5rem" styleClass="mb-3" />
        <p-skeleton width="50%" height="1rem" styleClass="mb-4" />
        <p-skeleton width="35%" height="3rem" styleClass="mb-4" />
        <p-skeleton height="120px" styleClass="mb-4 border-round" />
        <p-skeleton height="56px" styleClass="border-round" />
      </div>
    </div>
  } @else if (notFound()) {
    <!-- Phone Not Found -->
    <div class="col-12" role="alert">
      <p-card styleClass="border-round-xl">
        <div class="text-center py-8">
          <i class="pi pi-exclamation-circle text-7xl text-orange-500 mb-4" style="display: block;" aria-hidden="true"></i>
          <h2 class="text-3xl font-bold text-900 m-0 mb-3">Phone Not Found</h2>
          <p class="text-600 text-lg m-0 mb-5 line-height-3">
            The phone you're looking for is not available or doesn't exist.
          </p>
          <p-button
            icon="pi pi-arrow-left"
            label="Browse Available Phones"
            (onClick)="goBackToCatalog()"
            ariaLabel="Browse all available phones in catalog"
            styleClass="p-button-lg"
          />
        </div>
      </p-card>
    </div>
  } @else if (phone()) {
    <!-- Phone Detail Content - AC_REDESIGN_001: Redesigned layout -->
    <div class="grid">
      <!-- Image Gallery Section -->
      <article class="col-12 lg:col-7 xl:col-7" aria-label="Phone images">
        @if (galleriaImages.length > 0) {
          <div class="gallery-container surface-card border-round-xl p-3 shadow-1">
            <!-- Main Image -->
            <div
              class="gallery-main-image-wrapper border-round-lg overflow-hidden"
              style="height: 500px; background: linear-gradient(135deg, var(--surface-50) 0%, var(--surface-100) 100%);"
              (touchstart)="onTouchStart($event)"
              (touchmove)="onTouchMove($event)"
              (touchend)="onTouchEnd($event)"
            >
              @if (currentImage) {
                <!-- Loading spinner -->
                @if (imageLoading) {
                  <div class="gallery-loader">
                    <i class="pi pi-spin pi-spinner text-4xl text-primary"></i>
                  </div>
                }
                <img
                  [src]="currentImage.itemImageSrc"
                  [srcset]="currentImage.itemSrcSet"
                  sizes="(max-width: 1024px) 100vw, 60vw"
                  [alt]="currentImage.alt"
                  width="800"
                  height="500"
                  class="w-full h-full border-round-lg gallery-main-img"
                  [class.slide-from-left]="slideDirection === 'left'"
                  [class.slide-from-right]="slideDirection === 'right'"
                  [class.gallery-img-hidden]="imageLoading"
                  [style.transform]="getSwipeTransform()"
                  [style.transition]="swiping ? 'none' : ''"
                  style="object-fit: contain; user-select: none;"
                  draggable="false"
                  (load)="onImageLoad()"
                />
              }
              <!-- Navigation Arrows -->
              @if (galleriaImages.length > 1) {
                <button class="gallery-nav gallery-nav-prev" (click)="prevImage()" aria-label="Previous image">
                  <i class="pi pi-chevron-left"></i>
                </button>
                <button class="gallery-nav gallery-nav-next" (click)="nextImage()" aria-label="Next image">
                  <i class="pi pi-chevron-right"></i>
                </button>
              }
              <!-- Image Counter -->
              @if (galleriaImages.length > 1) {
                <span class="gallery-counter">{{ imageCounter }}</span>
              }
              <!-- Fullscreen Button -->
              <button class="gallery-fullscreen-btn" (click)="openFullscreen()" aria-label="View fullscreen">
                <i class="pi pi-expand"></i>
              </button>
            </div>

            <!-- Indicators -->
            @if (galleriaImages.length > 1) {
              <div class="flex justify-content-center gap-2 mt-3">
                @for (img of galleriaImages; track img.originalUrl; let i = $index) {
                  <button
                    class="gallery-indicator"
                    [class.gallery-indicator-active]="i === activeIndex"
                    (click)="selectImage(i)"
                    [attr.aria-label]="'Go to image ' + (i + 1)"
                  ></button>
                }
              </div>
            }

            <!-- Thumbnails - horizontal scroll -->
            @if (galleriaImages.length > 1) {
              <div class="gallery-thumbs-scroll mt-3">
                @for (img of galleriaImages; track img.originalUrl; let i = $index) {
                  <div
                    class="gallery-thumbnail border-round overflow-hidden cursor-pointer"
                    [class.gallery-thumbnail-active]="i === activeIndex"
                    (click)="selectImage(i)"
                  >
                    <img
                      [src]="img.thumbnailImageSrc"
                      [alt]="img.alt"
                      width="80"
                      height="60"
                      loading="lazy"
                      class="w-full h-full border-round"
                      style="object-fit: cover;"
                    />
                  </div>
                }
              </div>
            }
          </div>
        } @else {
          <div
            class="flex flex-column align-items-center justify-content-center surface-card border-round-xl gap-3 shadow-1"
            style="height: 500px;"
          >
            <i class="pi pi-image text-7xl text-300" aria-hidden="true"></i>
            <span class="text-400 text-lg">No images available</span>
          </div>
        }
      </article>

      <!-- Product Info Section -->
      <section class="col-12 lg:col-5 xl:col-5" aria-label="Phone specifications and details">
        <div class="product-info surface-card border-round-xl p-4 shadow-1 sticky" style="top: 1rem;">
          <!-- Brand & Status Row -->
          <div class="flex align-items-center justify-content-between mb-3">
            <div class="flex align-items-center gap-2">
              @if (phone()!.brandLogoUrl) {
                <img
                  [src]="phone()!.brandLogoUrl"
                  [alt]="phone()!.brandName"
                  style="width: 28px; height: 28px; object-fit: contain;"
                />
              }
              <span class="text-600 font-medium">{{ phone()!.brandName }}</span>
            </div>
            <p-tag
              [value]="getStatusLabel(phone()!.status)"
              [severity]="getStatusSeverity(phone()!.status)"
              [rounded]="true"
              styleClass="text-sm px-3 py-1"
            />
          </div>

          <!-- Model Name -->
          <h1 class="text-3xl lg:text-4xl font-bold text-900 m-0 mb-3 line-height-2">{{ phone()!.model }}</h1>

          <!-- Rating Summary - AC_REDESIGN_002 -->
          <div class="flex align-items-center gap-2 mb-4">
            <p-rating
              [ngModel]="averageRating()"
              [readonly]="true"
              [stars]="5"
              styleClass="rating-display"
            />
            <span class="text-600 font-medium">{{ averageRating() }}</span>
            <span class="text-400">|</span>
            <a href="javascript:void(0)" (click)="scrollToReviews()" class="text-primary no-underline hover:underline">
              {{ customerReviews().length }} reviews
            </a>
          </div>

          <!-- Price Section - AC_REDESIGN_001: Prominent display -->
          <div class="price-section surface-50 border-round-lg p-4 mb-4">
            <div class="flex align-items-baseline gap-2">
              <span class="text-4xl lg:text-5xl font-bold text-primary">
                {{ phone()!.sellingPrice | appCurrency }}
              </span>
              @if (hasDiscount()) {
                <span class="text-xl text-500 line-through">
                  {{ getOriginalPrice() | appCurrency }}
                </span>
              }
            </div>
            @if (hasDiscount()) {
              <div class="mt-2">
                <p-tag value="SAVE {{ getDiscountPercent() }}%" severity="danger" styleClass="font-semibold" />
              </div>
            }
          </div>

          <!-- Quick Specs Pills -->
          <div class="flex flex-wrap gap-2 mb-4">
            @if (phone()!.storageGb) {
              <span class="surface-100 px-3 py-2 border-round-lg text-sm font-medium flex align-items-center gap-2">
                <i class="pi pi-database text-primary" aria-hidden="true"></i>
                {{ phone()!.storageGb }}GB Storage
              </span>
            }
            @if (phone()!.ramGb) {
              <span class="surface-100 px-3 py-2 border-round-lg text-sm font-medium flex align-items-center gap-2">
                <i class="pi pi-microchip text-primary" aria-hidden="true"></i>
                {{ phone()!.ramGb }}GB RAM
              </span>
            }
            @if (phone()!.color) {
              <span class="surface-100 px-3 py-2 border-round-lg text-sm font-medium flex align-items-center gap-2">
                <i class="pi pi-palette text-primary" aria-hidden="true"></i>
                {{ phone()!.color }}
              </span>
            }
            <span class="px-3 py-2 border-round-lg text-sm font-medium flex align-items-center gap-2"
                  [ngClass]="getConditionBgClass(phone()!.condition)">
              <i class="pi pi-check-circle" aria-hidden="true"></i>
              {{ getConditionLabel(phone()!.condition) }}
            </span>
            @if (phone()!.ptaStatus) {
              <span class="surface-100 px-3 py-2 border-round-lg text-sm font-medium flex align-items-center gap-2">
                @if (phone()!.ptaStatus === 'pta_approved') {
                  <i class="pi pi-verified text-primary" aria-hidden="true"></i>
                  PTA Approved
                } @else {
                  <i class="pi pi-mobile text-primary" aria-hidden="true"></i>
                  Non PTA
                }
              </span>
            }
          </div>

          <!-- Battery Health (only for used/open box) -->
          @if (showBatteryHealth()) {
            <div class="battery-section surface-50 border-round-lg p-4 mb-4" role="group" aria-label="Battery health information">
              <div class="flex align-items-center justify-content-between mb-3">
                <div class="flex align-items-center gap-2">
                  <i class="pi pi-bolt text-xl" [ngClass]="getBatteryHealthClass(phone()!.batteryHealth)" aria-hidden="true"></i>
                  <span class="font-semibold text-900" id="battery-health-label">Battery Health</span>
                </div>
                <span
                  class="text-xl font-bold"
                  [ngClass]="getBatteryHealthClass(phone()!.batteryHealth)"
                  [attr.aria-label]="'Battery health is ' + phone()!.batteryHealth + ' percent'"
                >
                  {{ phone()!.batteryHealth }}%
                </span>
              </div>
              <p-progressBar
                [value]="phone()!.batteryHealth || 0"
                [showValue]="false"
                styleClass="h-1rem border-round-lg"
                [style]="{ 'background': 'var(--surface-200)' }"
                [ngClass]="getBatteryProgressClass(phone()!.batteryHealth)"
                role="progressbar"
                [attr.aria-valuenow]="phone()!.batteryHealth"
                aria-valuemin="0"
                aria-valuemax="100"
                aria-labelledby="battery-health-label"
              />
              <p class="text-sm text-500 mt-2 mb-0">{{ getBatteryHealthDescription(phone()!.batteryHealth) }}</p>
            </div>
          }

          <!-- CTA Buttons - AC_REDESIGN_001: Add to cart button -->
          <div class="flex flex-column gap-3">
            <p-button
              icon="pi pi-whatsapp"
              label="Inquire via WhatsApp"
              styleClass="w-full p-button-lg"
              severity="success"
              (onClick)="openWhatsAppInquiry()"
              pTooltip="Opens WhatsApp with a pre-filled message about this phone"
              tooltipPosition="top"
              ariaLabel="Inquire about {{ phone()!.brandName }} {{ phone()!.model }} via WhatsApp"
            />
            <p-button
              icon="pi pi-phone"
              label="Call to Reserve"
              styleClass="w-full p-button-lg"
              [outlined]="true"
              severity="primary"
              (onClick)="callToReserve()"
              ariaLabel="Call to reserve {{ phone()!.brandName }} {{ phone()!.model }}"
            />
          </div>
        </div>
      </section>
    </div>

    <!-- Full Specifications Section -->
    <div class="grid mt-5">
      <div class="col-12 lg:col-7">
        <!-- Description -->
        @if (phone()!.description) {
          <div class="surface-card border-round-xl p-4 shadow-1 mb-4">
            <h2 class="text-xl font-bold text-900 m-0 mb-3 flex align-items-center gap-2">
              <i class="pi pi-info-circle text-primary" aria-hidden="true"></i>
              About This Phone
            </h2>
            <p class="text-700 line-height-3 m-0">{{ phone()!.description }}</p>
          </div>
        }

        <!-- Full Specifications -->
        <div class="surface-card border-round-xl p-4 shadow-1 mb-4">
          <h2 class="text-xl font-bold text-900 m-0 mb-4 flex align-items-center gap-2">
            <i class="pi pi-list text-primary" aria-hidden="true"></i>
            Specifications
          </h2>
          <dl class="grid m-0" role="list" aria-label="Full phone specifications">
            <div class="col-12 md:col-6 flex justify-content-between py-3 border-bottom-1 surface-border">
              <dt class="text-600">Brand</dt>
              <dd class="text-900 font-medium m-0">{{ phone()!.brandName }}</dd>
            </div>
            <div class="col-12 md:col-6 flex justify-content-between py-3 border-bottom-1 surface-border">
              <dt class="text-600">Model</dt>
              <dd class="text-900 font-medium m-0">{{ phone()!.model }}</dd>
            </div>
            @if (phone()!.storageGb) {
              <div class="col-12 md:col-6 flex justify-content-between py-3 border-bottom-1 surface-border">
                <dt class="text-600">Storage</dt>
                <dd class="text-900 font-medium m-0">{{ phone()!.storageGb }}GB</dd>
              </div>
            }
            @if (phone()!.ramGb) {
              <div class="col-12 md:col-6 flex justify-content-between py-3 border-bottom-1 surface-border">
                <dt class="text-600">RAM</dt>
                <dd class="text-900 font-medium m-0">{{ phone()!.ramGb }}GB</dd>
              </div>
            }
            @if (phone()!.color) {
              <div class="col-12 md:col-6 flex justify-content-between py-3 border-bottom-1 surface-border">
                <dt class="text-600">Color</dt>
                <dd class="text-900 font-medium m-0">{{ phone()!.color }}</dd>
              </div>
            }
            <div class="col-12 md:col-6 flex justify-content-between py-3 border-bottom-1 surface-border">
              <dt class="text-600">Condition</dt>
              <dd class="m-0">
                <p-tag [value]="getConditionLabel(phone()!.condition)" [severity]="getConditionSeverity(phone()!.condition)" />
              </dd>
            </div>
            @if (phone()!.conditionRating) {
              <div class="col-12 md:col-6 flex justify-content-between py-3 border-bottom-1 surface-border">
                <dt class="text-600">Condition Rating</dt>
                <dd class="text-900 font-bold m-0">{{ phone()!.conditionRating }}/10</dd>
              </div>
            }
            @if (phone()!.ptaStatus) {
              <div class="col-12 md:col-6 flex justify-content-between py-3 border-bottom-1 surface-border">
                <dt class="text-600">PTA Status</dt>
                <dd class="m-0">
                  <p-tag
                    [value]="phone()!.ptaStatus === 'pta_approved' ? 'PTA Approved' : 'Non PTA'"
                    [severity]="phone()!.ptaStatus === 'pta_approved' ? 'success' : 'warn'"
                  />
                </dd>
              </div>
            }
            @if (showBatteryHealth()) {
              <div class="col-12 md:col-6 flex justify-content-between py-3 border-bottom-1 surface-border">
                <dt class="text-600">Battery Health</dt>
                <dd class="text-900 font-medium m-0" [ngClass]="getBatteryHealthClass(phone()!.batteryHealth)">{{ phone()!.batteryHealth }}%</dd>
              </div>
            }
            <div class="col-12 md:col-6 flex justify-content-between py-3">
              <dt class="text-600">Availability</dt>
              <dd class="m-0">
                <p-tag [value]="getStatusLabel(phone()!.status)" [severity]="getStatusSeverity(phone()!.status)" />
              </dd>
            </div>
          </dl>
        </div>
      </div>

      <!-- Sidebar Widgets -->
      <div class="col-12 lg:col-5">
        <!-- Trust Badges -->
        <div class="surface-card border-round-xl p-4 shadow-1 mb-4">
          <div class="flex flex-column gap-3">
            <div class="flex align-items-center gap-3">
              <div class="flex align-items-center justify-content-center bg-green-100 border-round-lg" style="width: 48px; height: 48px;">
                <i class="pi pi-verified text-xl text-green-600" aria-hidden="true"></i>
              </div>
              <div>
                <p class="font-semibold text-900 m-0">Quality Assured</p>
                <p class="text-sm text-500 m-0">Every phone is thoroughly inspected</p>
              </div>
            </div>
            <div class="flex align-items-center gap-3">
              <div class="flex align-items-center justify-content-center bg-blue-100 border-round-lg" style="width: 48px; height: 48px;">
                <i class="pi pi-shield text-xl text-blue-600" aria-hidden="true"></i>
              </div>
              <div>
                <p class="font-semibold text-900 m-0">Warranty Included</p>
                <p class="text-sm text-500 m-0">30-day warranty on all phones</p>
              </div>
            </div>
            <div class="flex align-items-center gap-3">
              <div class="flex align-items-center justify-content-center bg-purple-100 border-round-lg" style="width: 48px; height: 48px;">
                <i class="pi pi-sync text-xl text-purple-600" aria-hidden="true"></i>
              </div>
              <div>
                <p class="font-semibold text-900 m-0">Easy Returns</p>
                <p class="text-sm text-500 m-0">7-day hassle-free return policy</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Contact Card -->
        <div class="surface-card border-round-xl p-4 shadow-1">
          <h3 class="text-lg font-semibold text-900 m-0 mb-3">Need Help?</h3>
          <p class="text-600 text-sm m-0 mb-3">Have questions about this phone? Our team is here to help!</p>
          <div class="flex flex-column gap-2">
            <a href="tel:+1234567890" class="flex align-items-center gap-2 text-primary no-underline hover:underline">
              <i class="pi pi-phone" aria-hidden="true"></i>
              +1 (234) 567-890
            </a>
            <a href="mailto:info@phoneshop.com" class="flex align-items-center gap-2 text-primary no-underline hover:underline">
              <i class="pi pi-envelope" aria-hidden="true"></i>
              info&#64;phoneshop.com
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Customer Reviews Section - AC_REDESIGN_002 -->
    <div id="reviews-section" class="mt-5">
      <div class="surface-card border-round-xl p-4 shadow-1">
        <div class="flex flex-column md:flex-row md:align-items-center md:justify-content-between gap-3 mb-4">
          <h2 class="text-2xl font-bold text-900 m-0 flex align-items-center gap-2">
            <i class="pi pi-star-fill text-yellow-500" aria-hidden="true"></i>
            Customer Reviews
          </h2>
          <div class="flex align-items-center gap-3">
            <div class="flex align-items-center gap-2">
              <span class="text-3xl font-bold text-900">{{ averageRating() }}</span>
              <div class="flex flex-column">
                <p-rating [ngModel]="averageRating()" [readonly]="true" [stars]="5" styleClass="rating-display" />
                <span class="text-sm text-500">Based on {{ customerReviews().length }} reviews</span>
              </div>
            </div>
          </div>
        </div>

        @if (customerReviews().length > 0) {
          <div class="flex flex-column gap-4">
            @for (review of customerReviews(); track review.id) {
              <div class="review-card surface-50 border-round-lg p-4">
                <div class="flex align-items-start gap-3">
                  <p-avatar
                    [label]="review.customerInitials"
                    size="large"
                    shape="circle"
                    styleClass="bg-primary text-white font-semibold"
                  />
                  <div class="flex-grow-1">
                    <div class="flex flex-column sm:flex-row sm:align-items-center sm:justify-content-between gap-2 mb-2">
                      <div>
                        <span class="font-semibold text-900">{{ review.customerName }}</span>
                        @if (review.verified) {
                          <p-tag value="Verified Purchase" severity="success" styleClass="ml-2 text-xs" />
                        }
                      </div>
                      <span class="text-sm text-500">{{ review.date }}</span>
                    </div>
                    <p-rating [ngModel]="review.rating" [readonly]="true" [stars]="5" styleClass="rating-display mb-2" />
                    <p class="text-700 line-height-3 m-0">{{ review.comment }}</p>
                  </div>
                </div>
              </div>
            }
          </div>
        } @else {
          <div class="text-center py-6">
            <i class="pi pi-comments text-5xl text-300 mb-3" style="display: block;" aria-hidden="true"></i>
            <p class="text-600 m-0">No reviews yet. Be the first to share your experience!</p>
          </div>
        }
      </div>
    </div>
  }

  <!-- Sticky Mobile CTA Bar - AC_REDESIGN_003 -->
  @if (phone() && showStickyBar()) {
    <div class="sticky-mobile-bar lg:hidden fixed bottom-0 left-0 right-0 surface-card shadow-8 border-top-1 surface-border px-3 py-3 z-5">
      <div class="flex align-items-center justify-content-between gap-3">
        <div class="flex flex-column">
          <span class="text-sm text-500">{{ phone()!.brandName }} {{ phone()!.model }}</span>
          <span class="text-xl font-bold text-primary">{{ phone()!.sellingPrice | appCurrency }}</span>
        </div>
        <p-button
          icon="pi pi-whatsapp"
          label="Inquire"
          severity="success"
          (onClick)="openWhatsAppInquiry()"
          ariaLabel="Inquire via WhatsApp"
        />
      </div>
    </div>
  }

  <!-- Fullscreen Overlay -->
  @if (fullscreen && currentImage) {
    <div class="gallery-fullscreen-overlay" (click)="closeFullscreen()">
      <div class="gallery-fullscreen-content" (click)="$event.stopPropagation()">
        <!-- Close button -->
        <button class="gallery-fs-close" (click)="closeFullscreen()" aria-label="Close fullscreen">
          <i class="pi pi-times"></i>
        </button>
        <!-- Counter -->
        <span class="gallery-fs-counter">{{ imageCounter }}</span>
        <!-- Image -->
        <div
          class="gallery-fs-image-wrapper"
          (touchstart)="onTouchStart($event)"
          (touchend)="onTouchEnd($event)"
        >
          <img
            [src]="currentImage.itemImageSrc"
            [srcset]="currentImage.itemSrcSet"
            [alt]="currentImage.alt"
            class="gallery-fs-image"
            draggable="false"
          />
        </div>
        <!-- Navigation -->
        @if (galleriaImages.length > 1) {
          <button class="gallery-fs-nav gallery-fs-nav-prev" (click)="prevImage()" aria-label="Previous image">
            <i class="pi pi-chevron-left"></i>
          </button>
          <button class="gallery-fs-nav gallery-fs-nav-next" (click)="nextImage()" aria-label="Next image">
            <i class="pi pi-chevron-right"></i>
          </button>
        }
        <!-- Thumbnails -->
        @if (galleriaImages.length > 1) {
          <div class="gallery-fs-thumbs">
            @for (img of galleriaImages; track img.originalUrl; let i = $index) {
              <div
                class="gallery-fs-thumb"
                [class.gallery-fs-thumb-active]="i === activeIndex"
                (click)="selectImage(i)"
              >
                <img
                  [src]="img.thumbnailImageSrc"
                  [alt]="img.alt"
                  draggable="false"
                />
              </div>
            }
          </div>
        }
      </div>
    </div>
  }
</div>
