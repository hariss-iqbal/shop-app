<!-- ARIA Live Region for screen reader announcements -->
<div aria-live="polite" aria-atomic="true" class="sr-only" style="position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0,0,0,0);">
  {{ liveAnnouncement() }}
</div>

<p-confirmDialog />

<div class="grid">
  <!-- Back to Catalog -->
  <div class="col-12 mb-3">
    <p-button
      icon="pi pi-arrow-left"
      label="Back to Catalog"
      [text]="true"
      (onClick)="goBackToCatalog()"
    />
  </div>

  <div class="col-12">
    <div class="flex flex-column sm:flex-row align-items-start sm:align-items-center justify-content-between gap-3 mb-4">
      <div>
        <div class="flex align-items-center gap-2 mb-2">
          <i class="pi pi-arrows-h text-primary text-2xl"></i>
          <h1 class="text-3xl font-bold m-0">Product Comparison</h1>
        </div>
        <p class="text-color-secondary mt-0 mb-0">
          Compare up to 3 products side by side to find the perfect match
        </p>
      </div>
      @if (products().length > 0) {
        <div class="flex gap-2 flex-wrap">
          <p-button
            label="Add More"
            icon="pi pi-plus"
            [outlined]="true"
            size="small"
            (onClick)="goBackToCatalog()"
            [disabled]="products().length >= 3"
            pTooltip="Add more products to compare"
            tooltipPosition="top"
          />
          <p-button
            label="Share"
            icon="pi pi-share-alt"
            [outlined]="true"
            severity="secondary"
            size="small"
            (onClick)="shareComparison()"
            pTooltip="Copy shareable link"
            tooltipPosition="top"
          />
          <p-button
            label="Clear All"
            icon="pi pi-trash"
            [outlined]="true"
            severity="danger"
            size="small"
            (onClick)="confirmClearAll()"
          />
        </div>
      }
    </div>
  </div>

  @if (loading()) {
    <div class="col-12">
      <p-card>
        <div class="grid">
          @for (_ of [1, 2, 3]; track $index) {
            <div class="col-12 md:col-4">
              <p-skeleton height="200px" styleClass="mb-3" />
              <p-skeleton width="70%" styleClass="mb-2" />
              <p-skeleton width="50%" styleClass="mb-2" />
              <p-skeleton width="40%" />
            </div>
          }
        </div>
      </p-card>
    </div>
  } @else if (products().length === 0) {
    <div class="col-12">
      <p-card styleClass="text-center">
        <div class="py-8">
          <div class="flex justify-content-center mb-4">
            <div class="flex align-items-center justify-content-center border-circle surface-100"
                 style="width: 100px; height: 100px;">
              <i class="pi pi-arrows-h text-5xl text-primary"></i>
            </div>
          </div>
          <h2 class="text-900 text-2xl font-semibold m-0 mb-2">No products to compare</h2>
          <p class="text-500 mt-0 mb-4 line-height-3 mx-auto" style="max-width: 400px;">
            Select up to 3 products from the catalog to compare their specifications side by side and find the perfect product for you.
          </p>
          <p-button
            label="Browse Catalog"
            icon="pi pi-th-large"
            size="large"
            (onClick)="goBackToCatalog()"
          />
        </div>
      </p-card>
    </div>
  } @else if (products().length === 1) {
    <div class="col-12">
      <p-card styleClass="text-center">
        <div class="py-6">
          <div class="flex justify-content-center mb-4">
            <div class="flex align-items-center justify-content-center border-circle surface-100"
                 style="width: 80px; height: 80px;">
              <i class="pi pi-plus text-4xl text-primary"></i>
            </div>
          </div>
          <h2 class="text-900 text-xl font-semibold m-0 mb-2">Add one more product to compare</h2>
          <p class="text-500 mt-0 mb-4">
            You have selected 1 product. Add at least one more to start comparing.
          </p>
          <div class="flex gap-2 justify-content-center">
            <p-button
              label="Add More Products"
              icon="pi pi-plus"
              (onClick)="goBackToCatalog()"
            />
            <p-button
              label="Remove"
              icon="pi pi-trash"
              [outlined]="true"
              severity="secondary"
              (onClick)="clearAll()"
            />
          </div>
        </div>
        <!-- Show the single selected product -->
        <p-divider />
        @if (products()[0]; as singleProduct) {
          <div class="flex align-items-center justify-content-center gap-4 py-4">
            @if (singleProduct.primaryImageUrl) {
              <img [src]="getOptimizedUrl(singleProduct.primaryImageUrl)"
                   [alt]="singleProduct.brandName + ' ' + singleProduct.model"
                   style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;" />
            }
            <div class="text-left">
              <div class="text-500 text-sm mb-1">{{ singleProduct.brandName }}</div>
              <div class="font-bold text-lg">{{ singleProduct.model }}</div>
              <div class="text-primary font-bold">{{ singleProduct.sellingPrice | appCurrency }}</div>
            </div>
          </div>
        }
      </p-card>
    </div>
  } @else {
    <!-- Comparison Count Badge -->
    <div class="col-12 mb-3">
      <div class="flex align-items-center gap-2 text-color-secondary">
        <i class="pi pi-info-circle"></i>
        <span>Comparing {{ products().length }} products</span>
        @if (products().length < 3) {
          <span class="text-primary cursor-pointer" (click)="goBackToCatalog()">
            (Add {{ 3 - products().length }} more)
          </span>
        }
      </div>
    </div>

    <!-- Product Images & Names Row -->
    <div class="col-12">
      <p-card>
      <div class="overflow-x-auto">
        <table class="w-full comparison-table" style="border-collapse: separate; border-spacing: 0; min-width: 600px;">
          <!-- Product Headers -->
          <thead>
            <tr>
              <th class="text-left p-3 surface-50 border-round-left font-semibold text-color-secondary"
                  style="width: 180px; min-width: 180px;">
                Specification
              </th>
              @for (product of products(); track product.id) {
                <th class="text-center p-3 surface-50"
                    [class.border-round-right]="$last"
                    style="min-width: 200px;">
                  <div class="flex flex-column align-items-center gap-3">
                    <!-- Product Image -->
                    @if (product.primaryImageUrl) {
                      <div class="border-round overflow-hidden"
                           style="width: 140px; height: 140px; background-color: var(--surface-100);">
                        <img
                          [src]="getOptimizedUrl(product.primaryImageUrl)"
                          [alt]="product.brandName + ' ' + product.model"
                          width="140"
                          height="140"
                          class="w-full h-full border-round"
                          style="object-fit: cover;"
                        />
                      </div>
                    } @else {
                      <div class="flex flex-column align-items-center justify-content-center surface-100 border-round"
                           style="width: 140px; height: 140px;">
                        <i class="pi pi-image text-3xl text-400" aria-hidden="true"></i>
                      </div>
                    }
                    <!-- Brand & Model -->
                    <div class="flex flex-column align-items-center gap-1">
                      <div class="flex align-items-center gap-2">
                        @if (product.brandLogoUrl) {
                          <img [src]="product.brandLogoUrl" [alt]="product.brandName"
                               style="width: 20px; height: 20px; object-fit: contain;" />
                        }
                        <span class="text-500 text-sm">{{ product.brandName }}</span>
                      </div>
                      <span class="font-bold text-900">{{ product.model }}</span>
                    </div>
                    <!-- Actions -->
                    <div class="flex gap-2">
                      <p-button
                        icon="pi pi-eye"
                        [rounded]="true"
                        [text]="true"
                        severity="primary"
                        size="small"
                        pTooltip="View details"
                        tooltipPosition="top"
                        (onClick)="viewProduct(product)"
                      />
                      <p-button
                        icon="pi pi-times"
                        [rounded]="true"
                        [text]="true"
                        severity="danger"
                        size="small"
                        pTooltip="Remove from comparison"
                        tooltipPosition="top"
                        (onClick)="removeProduct(product.id)"
                      />
                    </div>
                  </div>
                </th>
              }
            </tr>
          </thead>

          <!-- Spec Rows -->
          <tbody>
            <!-- Price Row -->
            <tr>
              <td class="p-3 border-bottom-1 surface-border font-medium">
                <div class="flex align-items-center gap-2">
                  <i class="pi pi-dollar text-primary"></i>
                  <span>Price</span>
                </div>
              </td>
              @for (product of products(); track product.id) {
                <td class="text-center p-3 border-bottom-1 surface-border" [class.best-value-cell]="isBestPrice(product.sellingPrice)">
                  <div class="flex flex-column align-items-center gap-1">
                    <span class="text-xl font-bold text-primary">
                      {{ product.sellingPrice | appCurrency }}
                    </span>
                    @if (isBestPrice(product.sellingPrice)) {
                      <span class="best-value-badge">
                        <i class="pi pi-star-fill text-xs mr-1"></i>Best Price
                      </span>
                    }
                  </div>
                </td>
              }
            </tr>

            <!-- Brand Row -->
            <tr>
              <td class="p-3 border-bottom-1 surface-border font-medium">
                <div class="flex align-items-center gap-2">
                  <i class="pi pi-building text-primary"></i>
                  <span>Brand</span>
                </div>
              </td>
              @for (product of products(); track product.id) {
                <td class="text-center p-3 border-bottom-1 surface-border">
                  <div class="flex align-items-center justify-content-center gap-2">
                    @if (product.brandLogoUrl) {
                      <img [src]="product.brandLogoUrl" [alt]="product.brandName"
                           style="width: 20px; height: 20px; object-fit: contain;" />
                    }
                    <span class="font-medium">{{ product.brandName }}</span>
                  </div>
                </td>
              }
            </tr>

            <!-- Model Row -->
            <tr>
              <td class="p-3 border-bottom-1 surface-border font-medium">
                <div class="flex align-items-center gap-2">
                  <i class="pi pi-mobile text-primary"></i>
                  <span>Model</span>
                </div>
              </td>
              @for (product of products(); track product.id) {
                <td class="text-center p-3 border-bottom-1 surface-border font-medium">
                  {{ product.model }}
                </td>
              }
            </tr>

            <!-- Storage Row -->
            <tr>
              <td class="p-3 border-bottom-1 surface-border font-medium">
                <div class="flex align-items-center gap-2">
                  <i class="pi pi-database text-primary"></i>
                  <span>Storage</span>
                </div>
              </td>
              @for (product of products(); track product.id) {
                <td class="text-center p-3 border-bottom-1 surface-border" [class.best-value-cell]="isBestStorage(product.storageGb)">
                  @if (product.storageGb) {
                    <div class="flex flex-column align-items-center gap-1">
                      <span class="font-medium">{{ product.storageGb }}GB</span>
                      @if (isBestStorage(product.storageGb)) {
                        <span class="best-value-badge">
                          <i class="pi pi-check text-xs mr-1"></i>Most
                        </span>
                      }
                    </div>
                  } @else {
                    <span class="text-400">N/A</span>
                  }
                </td>
              }
            </tr>

            <!-- RAM Row -->
            <tr>
              <td class="p-3 border-bottom-1 surface-border font-medium">
                <div class="flex align-items-center gap-2">
                  <i class="pi pi-microchip text-primary"></i>
                  <span>RAM</span>
                </div>
              </td>
              @for (product of products(); track product.id) {
                <td class="text-center p-3 border-bottom-1 surface-border" [class.best-value-cell]="isBestRam(product.ramGb)">
                  @if (product.ramGb) {
                    <div class="flex flex-column align-items-center gap-1">
                      <span class="font-medium">{{ product.ramGb }}GB</span>
                      @if (isBestRam(product.ramGb)) {
                        <span class="best-value-badge">
                          <i class="pi pi-check text-xs mr-1"></i>Most
                        </span>
                      }
                    </div>
                  } @else {
                    <span class="text-400">N/A</span>
                  }
                </td>
              }
            </tr>

            <!-- Condition Row -->
            <tr>
              <td class="p-3 border-bottom-1 surface-border font-medium">
                <div class="flex align-items-center gap-2">
                  <i class="pi pi-check-circle text-primary"></i>
                  <span>Condition</span>
                </div>
              </td>
              @for (product of products(); track product.id) {
                <td class="text-center p-3 border-bottom-1 surface-border">
                  <p-tag
                    [value]="getConditionLabel(product.condition)"
                    [severity]="getConditionSeverity(product.condition)"
                  />
                </td>
              }
            </tr>

            <!-- Battery Health Row -->
            <tr>
              <td class="p-3 border-bottom-1 surface-border font-medium">
                <div class="flex align-items-center gap-2">
                  <i class="pi pi-bolt text-primary"></i>
                  <span>Battery Health</span>
                </div>
              </td>
              @for (product of products(); track product.id) {
                <td class="text-center p-3 border-bottom-1 surface-border" [class.best-value-cell]="isBestBatteryHealth(product)">
                  @if (product.batteryHealth !== null && product.condition !== conditionNew) {
                    <div class="flex flex-column align-items-center gap-2">
                      <span class="font-bold" [ngClass]="getBatteryHealthClass(product.batteryHealth)">
                        {{ product.batteryHealth }}%
                      </span>
                      <p-progressBar
                        [value]="product.batteryHealth"
                        [showValue]="false"
                        styleClass="h-0.5rem w-6rem"
                        [ngClass]="getBatteryProgressClass(product.batteryHealth)"
                      />
                      @if (isBestBatteryHealth(product)) {
                        <span class="best-value-badge">
                          <i class="pi pi-check text-xs mr-1"></i>Best
                        </span>
                      }
                    </div>
                  } @else if (product.condition === conditionNew) {
                    <span class="text-green-600 font-medium">New</span>
                  } @else {
                    <span class="text-400">N/A</span>
                  }
                </td>
              }
            </tr>

            <!-- Color Row -->
            <tr>
              <td class="p-3 border-bottom-1 surface-border font-medium">
                <div class="flex align-items-center gap-2">
                  <i class="pi pi-palette text-primary"></i>
                  <span>Color</span>
                </div>
              </td>
              @for (product of products(); track product.id) {
                <td class="text-center p-3 border-bottom-1 surface-border">
                  @if (product.color) {
                    <span class="font-medium">{{ product.color }}</span>
                  } @else {
                    <span class="text-400">N/A</span>
                  }
                </td>
              }
            </tr>
          </tbody>
        </table>
      </div>
      </p-card>
    </div>

    <!-- Quick Actions -->
    <div class="col-12 mt-4">
      <div class="flex flex-wrap gap-2 justify-content-center">
        <p-button
          label="Back to Catalog"
          icon="pi pi-arrow-left"
          [outlined]="true"
          severity="secondary"
          (onClick)="goBackToCatalog()"
        />
        @if (products().length < 3) {
          <p-button
            label="Add More Products"
            icon="pi pi-plus"
            [outlined]="true"
            (onClick)="goBackToCatalog()"
          />
        }
      </div>
    </div>
  }
</div>
