<div class="catalog-container">
  <!-- Toolbar -->
  <div class="catalog-toolbar">
    <div class="flex align-items-center gap-3 flex-grow-1">
      <h2 class="m-0 text-color font-bold" style="font-size: 1.25rem;">Smartphones</h2>
      @if (!loading()) {
        <span class="text-color-secondary text-sm">{{ totalRecords() }} results</span>
      }
    </div>
    <div class="flex align-items-center gap-2">
      <!-- Mobile Filters Button -->
      <div class="lg:hidden">
        <p-button
          icon="pi pi-filter"
          label="Filters"
          [outlined]="true"
          size="small"
          (onClick)="openFilterDrawer()"
          [badge]="activeFilterCount() > 0 ? activeFilterCount().toString() : ''"
          badgeSeverity="info"
        />
      </div>

      <!-- Sort -->
      <div class="flex align-items-center gap-2">
        <span class="text-color-secondary text-sm hidden sm:inline">Sort by:</span>
        <p-select
          [options]="sortOptions"
          [(ngModel)]="selectedSort"
          (onChange)="onSortChange()"
          optionLabel="label"
          styleClass="w-auto"
          aria-label="Sort catalog by"
        >
          <ng-template let-sort pTemplate="selectedItem">
            @if (sort) {
              <div class="flex align-items-center gap-2">
                <i [class]="sort.icon + ' text-primary'" aria-hidden="true"></i>
                <span>{{ sort.label }}</span>
              </div>
            }
          </ng-template>
          <ng-template let-sort pTemplate="item">
            <div class="flex align-items-center justify-content-between w-full gap-3">
              <div class="flex align-items-center gap-2">
                <i [class]="sort.icon + ' text-500'" aria-hidden="true"></i>
                <span>{{ sort.label }}</span>
              </div>
              @if (sort.value === selectedSort.value) {
                <i class="pi pi-check text-primary font-bold" aria-hidden="true"></i>
              }
            </div>
          </ng-template>
        </p-select>
      </div>
    </div>
  </div>

  <!-- Main Layout: Sidebar + Content -->
  <div class="catalog-layout">
    <!-- Desktop Sidebar -->
    <aside class="catalog-sidebar hidden lg:block">
      <div class="sidebar-card">
        <!-- Filters header -->
        <div class="flex align-items-center justify-content-between mb-3">
          <div class="flex align-items-center gap-2">
            <i class="pi pi-filter text-color-secondary" style="font-size: 0.9rem;"></i>
            <span class="font-bold text-sm text-color">Filters</span>
          </div>
          @if (hasActiveFilters()) {
            <a class="text-xs font-semibold cursor-pointer" style="color: #3c8df6;" (click)="clearFilters()">Clear All</a>
          }
        </div>
        <ng-container *ngTemplateOutlet="filterControls" />
      </div>
    </aside>

    <!-- Main Content Area -->
    <div class="catalog-main">
      <!-- Results -->
      @if (loading()) {
        <!-- Loading Skeletons -->
        <div class="catalog-grid">
          @for (_ of skeletonItems; track $index) {
            <div class="skeleton-card">
              <p-skeleton height="16rem" styleClass="mb-0 border-round-top-xl" />
              <div class="p-3">
                <p-skeleton width="40%" height="0.625rem" styleClass="mb-2" />
                <p-skeleton width="75%" height="1rem" styleClass="mb-3" />
                <div class="flex gap-2 mb-3">
                  <p-skeleton width="50px" height="1.25rem" borderRadius="6px" />
                  <p-skeleton width="60px" height="1.25rem" borderRadius="6px" />
                </div>
                <p-skeleton width="50%" height="1.125rem" />
              </div>
            </div>
          }
        </div>
      } @else if (products().length === 0) {
        <div class="empty-state-card">
          <div class="text-center py-6">
            <i class="pi pi-search text-4xl mb-3" style="display: block; color: #94a3b8;"></i>
            <p class="text-color text-xl font-semibold m-0">No products found</p>
            <p class="text-color-secondary mt-2 mb-4">
              @if (hasActiveFilters()) {
                No products match your current filters
              } @else {
                No products are currently available
              }
            </p>
            @if (hasActiveFilters()) {
              <p-button
                label="Clear All Filters"
                icon="pi pi-filter-slash"
                [outlined]="true"
                (onClick)="clearFilters()"
              />
            }
          </div>
        </div>
      } @else {
        <!-- F-042: Live region for screen readers -->
        <div aria-live="polite" aria-atomic="true" class="sr-only" style="position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0,0,0,0);">
          {{ totalRecords() }} products found
        </div>

        <!-- Product Grid -->
        <div class="catalog-grid fadein animation-duration-300" role="list" aria-label="Product catalog grid">
          @for (product of products(); track product.id) {
            <div role="listitem"
                 tabindex="0"
                 class="product-card-focusable"
                 [attr.aria-label]="product.brandName + ' ' + product.model + ', ' + getConditionLabel(product.condition) + ', ' + (product.sellingPrice | appCurrency) + '. Press Enter to view details.'"
                 appProductCardKeyboard
                 (cardActivated)="viewProduct(product)">
              <app-product-card
                [product]="product"
                [index]="$index"
                [eagerLoad]="$index < 4"
                (compareToggled)="onCompareToggled($event)"
              />
            </div>
          }
        </div>

        <!-- Pagination -->
        @if (totalRecords() > pageSize) {
          <div class="mt-4" role="navigation" aria-label="Catalog pagination">
            <p-paginator
              [rows]="pageSize"
              [totalRecords]="totalRecords()"
              [first]="first"
              (onPageChange)="onPageChange($event)"
              [showCurrentPageReport]="true"
              currentPageReportTemplate="Showing {first} to {last} of {totalRecords} products"
              [rowsPerPageOptions]="[12, 24, 48]"
              [showFirstLastIcon]="true"
              [showPageLinks]="true"
              [showJumpToPageDropdown]="totalRecords() > 100"
              styleClass="justify-content-center"
            />
          </div>
        }
      }
    </div>
  </div>
</div>

<!-- Mobile Filter Drawer -->
<p-drawer [(visible)]="filterDrawerVisible" position="left" [modal]="true" styleClass="w-20rem" ariaCloseLabel="Close filters">
  <ng-template pTemplate="header">
    <div class="flex align-items-center gap-2">
      <i class="pi pi-filter text-primary text-xl" aria-hidden="true"></i>
      <span class="font-bold text-lg">Filters</span>
      @if (activeFilterCount() > 0) {
        <p-badge [value]="activeFilterCount().toString()" severity="info" />
      }
    </div>
  </ng-template>
  @if (filterDrawerVisible) {
    <ng-container *ngTemplateOutlet="filterControls" />
  }
</p-drawer>

<!-- Filter Controls Template (shared between sidebar and drawer) -->
<ng-template #filterControls>
  <div class="filter-panel">
    <!-- Search -->
    <div class="filter-group">
      <label for="search" class="filter-label">Search</label>
      <p-iconfield styleClass="w-full">
        <p-inputicon styleClass="pi pi-search" />
        <input
          id="search"
          pInputText
          [(ngModel)]="searchQuery"
          (input)="onSearchInput($event)"
          class="w-full"
          placeholder="Search by brand or model..."
          aria-describedby="search-hint"
        />
        @if (searchQuery) {
          <p-inputicon styleClass="pi pi-times cursor-pointer" (click)="clearSearch()" />
        }
      </p-iconfield>
    </div>

    <!-- Brand Filter: Checkboxes -->
    <div class="filter-group">
      <label class="filter-label">Brand</label>
      <div class="brand-checkbox-list">
        @for (brand of brands(); track brand.id) {
          <div class="flex align-items-center gap-2 mb-2">
            <p-checkbox
              [value]="brand.id"
              [(ngModel)]="selectedBrandIds"
              (onChange)="onFilterChange()"
              [inputId]="'brand-' + brand.id"
            />
            <label [for]="'brand-' + brand.id" class="text-sm cursor-pointer text-color" style="font-weight: 500;">
              @if (brand.logoUrl) {
                <img [src]="brand.logoUrl" [alt]="brand.name" style="width: 18px; height: 18px; object-fit: contain; vertical-align: middle; margin-right: 0.35rem;" (error)="onImageError($event)" />
              }
              {{ brand.name }}
            </label>
          </div>
        }
      </div>
    </div>

    <!-- Condition Filter: Checkboxes -->
    <div class="filter-group">
      <label class="filter-label">Condition</label>
      <div class="condition-checkbox-list">
        @for (cond of conditionOptions; track cond.value) {
          <div class="flex align-items-center gap-2 mb-2">
            <p-checkbox
              [value]="cond.value"
              [(ngModel)]="selectedConditions"
              (onChange)="onFilterChange()"
              [inputId]="'cond-' + cond.value"
            />
            <label [for]="'cond-' + cond.value" class="text-sm cursor-pointer text-color" style="font-weight: 500;">{{ cond.label }}</label>
          </div>
        }
      </div>
    </div>

    <!-- PTA Status Filter -->
    <div class="filter-group">
      <label for="ptaStatus" class="filter-label">PTA Status</label>
      <p-select
        id="ptaStatus"
        [(ngModel)]="selectedPtaStatus"
        [options]="ptaStatusOptions"
        optionLabel="label"
        optionValue="value"
        placeholder="All PTA Status"
        styleClass="w-full"
        [showClear]="true"
        (onChange)="onFilterChange()"
        ariaLabel="Filter by PTA status"
      />
    </div>

    <!-- Storage Filter: Toggle Buttons -->
    <div class="filter-group">
      <label class="filter-label">Storage</label>
      <div class="storage-grid">
        @for (opt of storageOptions(); track opt.value) {
          <button
            type="button"
            class="storage-toggle-btn"
            [class.storage-toggle-active]="selectedStorageValues.includes(opt.value)"
            (click)="toggleStorageValue(opt.value)"
          >
            {{ opt.label }}
          </button>
        }
      </div>
    </div>

    <!-- Price Range Slider -->
    <div class="filter-group">
      <label class="filter-label">Price Range</label>
      <div class="flex justify-content-between mb-2" style="font-size: 0.75rem; color: #94a3b8;">
        <span>{{ priceRange[0] | appCurrency }}</span>
        <span>{{ priceRange[1] | appCurrency }}</span>
      </div>
      <div class="px-1">
        <p-slider
          [(ngModel)]="priceRange"
          [range]="true"
          [min]="priceMin()"
          [max]="priceMax()"
          [step]="10"
          (onSlideEnd)="onPriceRangeChange()"
          styleClass="w-full"
        />
      </div>
    </div>

    <!-- Active Filter Chips -->
    @if (activeFilters().length > 0) {
      <div class="filter-group">
        <div class="flex align-items-center justify-content-between mb-2">
          <span class="filter-label m-0">Active Filters</span>
          <p-button
            label="Clear All"
            icon="pi pi-filter-slash"
            [text]="true"
            severity="secondary"
            size="small"
            (onClick)="clearFilters()"
          />
        </div>
        <div class="flex flex-wrap gap-2">
          @for (filter of activeFilters(); track filter.type + '-' + filter.value) {
            <p-chip
              [label]="filter.label"
              [removable]="true"
              (onRemove)="removeFilter(filter)"
              styleClass="bg-primary-100 text-primary"
            />
          }
        </div>
      </div>
    }
  </div>
</ng-template>

<!-- Floating Comparison Bar -->
@if (comparisonService.hasProducts()) {
  <div class="fixed bottom-0 left-0 right-0 z-5 surface-overlay shadow-8 border-top-1 surface-border px-3 py-3 sm:px-4 lg:px-6 fadein animation-duration-300">
    <div class="flex align-items-center justify-content-between gap-3 flex-wrap">
      <div class="flex align-items-center gap-3 flex-wrap flex-grow-1">
        <span class="font-semibold white-space-nowrap">
          Compare ({{ comparisonService.count() }}/3):
        </span>
        @for (product of comparisonService.products(); track product.id) {
          <div class="flex align-items-center gap-2 surface-100 border-round px-3 py-2">
            @if (product.primaryImageUrl) {
              <img [src]="getCardOptimizedUrl(product.primaryImageUrl)"
                   [alt]="product.brandName + ' ' + product.model"
                   style="width: 32px; height: 32px; object-fit: cover; border-radius: 4px;"
                   (error)="onImageError($event)" />
            }
            <span class="text-sm font-medium white-space-nowrap">{{ product.brandName }} {{ product.model }}</span>
            <p-button
              icon="pi pi-times"
              [rounded]="true"
              [text]="true"
              severity="danger"
              size="small"
              (onClick)="removeFromCompare(product.id)"
              ariaLabel="Remove from comparison"
            />
          </div>
        }
      </div>
      <div class="flex align-items-center gap-2">
        <p-button
          label="Clear"
          [text]="true"
          severity="secondary"
          size="small"
          (onClick)="clearComparison()"
        />
        <p-button
          label="Compare Now"
          icon="pi pi-arrows-h"
          [disabled]="!comparisonService.canCompare()"
          (onClick)="goToComparison()"
          size="small"
        />
      </div>
    </div>
  </div>
}
