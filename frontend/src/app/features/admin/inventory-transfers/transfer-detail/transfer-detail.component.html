<div class="flex flex-column gap-4">
  <div class="flex justify-content-between align-items-center flex-wrap gap-2">
    <div class="flex align-items-center gap-3">
      <p-button
        icon="pi pi-arrow-left"
        [text]="true"
        severity="secondary"
        routerLink="/admin/inventory-transfers"
        pTooltip="Back to transfers">
      </p-button>
      <h2 class="m-0">Transfer {{ transfer()?.transferNumber }}</h2>
      @if (transfer()) {
        <p-tag
          [value]="getStatusLabel(transfer()!.status)"
          [severity]="getStatusSeverity(transfer()!.status)">
        </p-tag>
      }
    </div>
    @if (transfer() && canTakeAction()) {
      <div class="flex gap-2">
        @if (transfer()!.status === 'pending') {
          <p-button
            label="Start Transit"
            icon="pi pi-truck"
            severity="info"
            [loading]="actionLoading()"
            (onClick)="startTransit()">
          </p-button>
        }
        @if (transfer()!.status === 'pending' || transfer()!.status === 'in_transit') {
          <p-button
            label="Complete Transfer"
            icon="pi pi-check"
            severity="success"
            [loading]="actionLoading()"
            (onClick)="completeTransfer()">
          </p-button>
          <p-button
            label="Cancel Transfer"
            icon="pi pi-times"
            severity="danger"
            [outlined]="true"
            [loading]="actionLoading()"
            (onClick)="confirmCancel()">
          </p-button>
        }
      </div>
    }
  </div>

  @if (loading()) {
    <div class="flex justify-content-center p-5">
      <i class="pi pi-spinner pi-spin text-4xl text-primary"></i>
    </div>
  } @else if (transfer()) {
    <div class="grid">
      <div class="col-12 lg:col-8">
        <p-card header="Transfer Items">
          <p-table
            [value]="transfer()!.items || []"
            styleClass="p-datatable-sm p-datatable-striped">

            <ng-template pTemplate="header">
              <tr>
                <th>Phone</th>
                <th>Brand</th>
                <th>Condition</th>
                <th class="text-right">Quantity</th>
                <th>Notes</th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-item>
              <tr>
                <td>
                  <span class="font-medium">{{ item.phone?.model || 'Unknown' }}</span>
                </td>
                <td>{{ item.phone?.brandName || '-' }}</td>
                <td>
                  @if (item.phone?.condition) {
                    <p-tag
                      [value]="item.phone.condition | titlecase"
                      [severity]="getConditionSeverity(item.phone.condition)">
                    </p-tag>
                  } @else {
                    -
                  }
                </td>
                <td class="text-right font-bold">{{ item.quantity }}</td>
                <td class="text-color-secondary">{{ item.notes || '-' }}</td>
              </tr>
            </ng-template>

            <ng-template pTemplate="footer">
              <tr>
                <td colspan="3" class="text-right font-bold">Total Items:</td>
                <td class="text-right font-bold text-primary">{{ totalQuantity() }}</td>
                <td></td>
              </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="5" class="text-center p-4 text-color-secondary">
                  No items in this transfer.
                </td>
              </tr>
            </ng-template>
          </p-table>
        </p-card>
      </div>

      <div class="col-12 lg:col-4">
        <div class="flex flex-column gap-4">
          <p-card header="Transfer Information">
            <div class="flex flex-column gap-3">
              <div>
                <label class="text-color-secondary text-sm block mb-1">Transfer Number</label>
                <span class="font-medium">{{ transfer()!.transferNumber }}</span>
              </div>

              <p-divider />

              <div>
                <label class="text-color-secondary text-sm block mb-1">From Location</label>
                <div class="flex align-items-center gap-2">
                  <i class="pi pi-map-marker text-blue-500"></i>
                  <div>
                    <span class="font-medium">{{ transfer()!.sourceLocation?.name }}</span>
                    <span class="text-color-secondary ml-1">({{ transfer()!.sourceLocation?.code }})</span>
                  </div>
                </div>
              </div>

              <div>
                <label class="text-color-secondary text-sm block mb-1">To Location</label>
                <div class="flex align-items-center gap-2">
                  <i class="pi pi-map-marker text-green-500"></i>
                  <div>
                    <span class="font-medium">{{ transfer()!.destinationLocation?.name }}</span>
                    <span class="text-color-secondary ml-1">({{ transfer()!.destinationLocation?.code }})</span>
                  </div>
                </div>
              </div>

              <p-divider />

              <div>
                <label class="text-color-secondary text-sm block mb-1">Status</label>
                <p-tag
                  [value]="getStatusLabel(transfer()!.status)"
                  [severity]="getStatusSeverity(transfer()!.status)">
                </p-tag>
              </div>

              @if (transfer()!.notes) {
                <div>
                  <label class="text-color-secondary text-sm block mb-1">Notes</label>
                  <p class="m-0">{{ transfer()!.notes }}</p>
                </div>
              }
            </div>
          </p-card>

          <p-card header="Timeline">
            <p-timeline [value]="timelineEvents()" align="left">
              <ng-template let-event pTemplate="content">
                <div class="flex flex-column">
                  <span class="font-medium">{{ event.status }}</span>
                  @if (event.date) {
                    <span class="text-color-secondary text-sm">{{ event.date | date:'medium' }}</span>
                  } @else {
                    <span class="text-color-secondary text-sm">Pending</span>
                  }
                </div>
              </ng-template>
              <ng-template let-event pTemplate="marker">
                <span
                  class="flex align-items-center justify-content-center border-circle"
                  [style.backgroundColor]="event.color"
                  style="width: 2rem; height: 2rem;">
                  <i [class]="event.icon" class="text-white text-sm"></i>
                </span>
              </ng-template>
            </p-timeline>
          </p-card>
        </div>
      </div>
    </div>
  } @else {
    <p-card>
      <div class="text-center p-4">
        <i class="pi pi-exclamation-circle text-4xl text-color-secondary mb-3"></i>
        <p class="text-lg m-0">Transfer not found</p>
        <p-button
          label="Back to Transfers"
          [text]="true"
          routerLink="/admin/inventory-transfers"
          class="mt-3">
        </p-button>
      </div>
    </p-card>
  }
</div>

<p-confirmDialog></p-confirmDialog>
