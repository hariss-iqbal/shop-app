<div class="flex flex-column gap-4">
  <div class="flex flex-column md:flex-row justify-content-between align-items-start md:align-items-center gap-3">
    <div>
      <h2 class="m-0 mb-1">Inventory Transfers</h2>
      <p class="m-0 text-color-secondary text-sm">Manage stock transfers between locations</p>
    </div>
    <p-button
      label="New Transfer"
      icon="pi pi-plus"
      routerLink="new">
    </p-button>
  </div>

  <!-- Filter Section -->
  <div class="surface-card shadow-1 border-round p-3">
    <div class="flex flex-column md:flex-row gap-3 align-items-start md:align-items-end flex-wrap">
      <div class="flex flex-column gap-1 flex-grow-1" style="min-width: 180px;">
        <label class="text-sm text-color-secondary font-medium">Source Location</label>
        <p-select
          [options]="locations()"
          [(ngModel)]="filter.sourceLocationId"
          (onChange)="loadTransfers()"
          optionLabel="name"
          optionValue="id"
          placeholder="All locations"
          [showClear]="true"
          [style]="{ width: '100%' }">
          <ng-template let-location pTemplate="item">
            <div class="flex align-items-center gap-2">
              <i class="pi pi-map-marker text-blue-500"></i>
              <span>{{ location.name }}</span>
              <span class="text-color-secondary text-sm">({{ location.code }})</span>
            </div>
          </ng-template>
        </p-select>
      </div>

      <div class="hidden md:flex align-items-center" style="padding-bottom: 0.5rem;">
        <i class="pi pi-arrow-right text-color-secondary"></i>
      </div>

      <div class="flex flex-column gap-1 flex-grow-1" style="min-width: 180px;">
        <label class="text-sm text-color-secondary font-medium">Destination Location</label>
        <p-select
          [options]="locations()"
          [(ngModel)]="filter.destinationLocationId"
          (onChange)="loadTransfers()"
          optionLabel="name"
          optionValue="id"
          placeholder="All locations"
          [showClear]="true"
          [style]="{ width: '100%' }">
          <ng-template let-location pTemplate="item">
            <div class="flex align-items-center gap-2">
              <i class="pi pi-map-marker text-green-500"></i>
              <span>{{ location.name }}</span>
              <span class="text-color-secondary text-sm">({{ location.code }})</span>
            </div>
          </ng-template>
        </p-select>
      </div>

      <div class="flex flex-column gap-1" style="min-width: 150px;">
        <label class="text-sm text-color-secondary font-medium">Status</label>
        <p-select
          [options]="statusOptions"
          [(ngModel)]="filter.status"
          (onChange)="loadTransfers()"
          optionLabel="label"
          optionValue="value"
          placeholder="All statuses"
          [showClear]="true"
          [style]="{ width: '100%' }">
        </p-select>
      </div>

      <p-button
        icon="pi pi-filter-slash"
        severity="secondary"
        [text]="true"
        pTooltip="Clear filters"
        tooltipPosition="top"
        (onClick)="clearFilters()"
        [disabled]="!hasActiveFilters()">
      </p-button>
    </div>
  </div>

  <p-table
    [value]="transfers()"
    [loading]="loading()"
    [lazy]="true"
    [paginator]="true"
    [rows]="10"
    [totalRecords]="totalRecords()"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} transfers"
    (onLazyLoad)="onLazyLoad($event)"
    styleClass="p-datatable-striped">

    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="transfer_number">Transfer # <p-sortIcon field="transfer_number"></p-sortIcon></th>
        <th>From</th>
        <th>To</th>
        <th pSortableColumn="status">Status <p-sortIcon field="status"></p-sortIcon></th>
        <th>Items</th>
        <th pSortableColumn="initiated_at">Initiated <p-sortIcon field="initiated_at"></p-sortIcon></th>
        <th>Actions</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-transfer>
      <tr>
        <td>
          <span class="font-medium">{{ transfer.transferNumber }}</span>
        </td>
        <td>
          {{ transfer.sourceLocation?.name || 'Unknown' }}
          <span class="text-color-secondary">({{ transfer.sourceLocation?.code }})</span>
        </td>
        <td>
          {{ transfer.destinationLocation?.name || 'Unknown' }}
          <span class="text-color-secondary">({{ transfer.destinationLocation?.code }})</span>
        </td>
        <td>
          <p-tag
            [value]="getStatusLabel(transfer.status)"
            [severity]="getStatusSeverity(transfer.status)">
          </p-tag>
        </td>
        <td>{{ transfer.items?.length || 0 }} items</td>
        <td>{{ transfer.initiatedAt | date:'medium' }}</td>
        <td>
          <div class="flex gap-2">
            <p-button
              icon="pi pi-eye"
              [rounded]="true"
              [text]="true"
              severity="info"
              pTooltip="View Details"
              [routerLink]="[transfer.id]">
            </p-button>
            @if (transfer.status === 'pending') {
              <p-button
                icon="pi pi-truck"
                [rounded]="true"
                [text]="true"
                severity="info"
                pTooltip="Start Transit"
                (onClick)="startTransit(transfer)">
              </p-button>
            }
            @if (transfer.status === 'pending' || transfer.status === 'in_transit') {
              <p-button
                icon="pi pi-check"
                [rounded]="true"
                [text]="true"
                severity="success"
                pTooltip="Complete Transfer"
                (onClick)="completeTransfer(transfer)">
              </p-button>
              <p-button
                icon="pi pi-times"
                [rounded]="true"
                [text]="true"
                severity="danger"
                pTooltip="Cancel Transfer"
                (onClick)="confirmCancel(transfer)">
              </p-button>
            }
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="7" class="text-center p-5">
          <div class="flex flex-column align-items-center gap-3">
            <i class="pi pi-arrows-h text-4xl text-color-secondary"></i>
            <span class="text-lg text-color-secondary">No transfers found</span>
            <p-button
              label="Create New Transfer"
              icon="pi pi-plus"
              routerLink="new">
            </p-button>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>

<p-confirmDialog></p-confirmDialog>
