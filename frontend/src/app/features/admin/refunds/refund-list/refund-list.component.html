<div class="grid">
  <div class="col-12 flex align-items-center justify-content-between mb-4">
    <h1 class="text-3xl font-bold m-0">Refunds</h1>
    <div class="flex align-items-center gap-2">
      <p-button
        label="Process Refund"
        icon="pi pi-refresh"
        routerLink="/admin/receipts"
        pTooltip="Go to receipts to process a refund"
        tooltipPosition="left"
      />
    </div>
  </div>

  <!-- Summary Statistics -->
  <div class="col-12 mb-4">
    <div class="grid">
      <div class="col-12 md:col-6 lg:col-3">
        <p-card styleClass="h-full">
          @if (loading()) {
            <div class="flex align-items-center justify-content-between">
              <div class="flex-1">
                <p-skeleton width="60%" styleClass="mb-2" />
                <p-skeleton width="50%" height="2rem" />
              </div>
              <p-skeleton shape="circle" size="3rem" />
            </div>
          } @else {
            <div class="flex align-items-center justify-content-between">
              <div>
                <span class="block text-color-secondary mb-2">Total Refunds</span>
                <span class="text-3xl font-bold">{{ summary()?.totalRefunds || 0 }}</span>
              </div>
              <div class="w-3rem h-3rem border-circle bg-red-100 flex align-items-center justify-content-center">
                <i class="pi pi-refresh text-red-500 text-xl"></i>
              </div>
            </div>
          }
        </p-card>
      </div>
      <div class="col-12 md:col-6 lg:col-3">
        <p-card styleClass="h-full">
          @if (loading()) {
            <div class="flex align-items-center justify-content-between">
              <div class="flex-1">
                <p-skeleton width="60%" styleClass="mb-2" />
                <p-skeleton width="50%" height="2rem" />
              </div>
              <p-skeleton shape="circle" size="3rem" />
            </div>
          } @else {
            <div class="flex align-items-center justify-content-between">
              <div>
                <span class="block text-color-secondary mb-2">Total Refunded</span>
                <span class="text-3xl font-bold text-red-500">{{ summary()?.totalRefundAmount || 0 | appCurrency:'1.2-2' }}</span>
              </div>
              <div class="w-3rem h-3rem border-circle bg-red-100 flex align-items-center justify-content-center">
                <i class="pi pi-dollar text-red-500 text-xl"></i>
              </div>
            </div>
          }
        </p-card>
      </div>
      <div class="col-12 md:col-6 lg:col-3">
        <p-card styleClass="h-full">
          @if (loading()) {
            <div class="flex align-items-center justify-content-between">
              <div class="flex-1">
                <p-skeleton width="60%" styleClass="mb-2" />
                <p-skeleton width="50%" height="2rem" />
              </div>
              <p-skeleton shape="circle" size="3rem" />
            </div>
          } @else {
            <div class="flex align-items-center justify-content-between">
              <div>
                <span class="block text-color-secondary mb-2">Items Refunded</span>
                <span class="text-3xl font-bold">{{ summary()?.totalItemsRefunded || 0 }}</span>
              </div>
              <div class="w-3rem h-3rem border-circle bg-orange-100 flex align-items-center justify-content-center">
                <i class="pi pi-box text-orange-500 text-xl"></i>
              </div>
            </div>
          }
        </p-card>
      </div>
      <div class="col-12 md:col-6 lg:col-3">
        <p-card styleClass="h-full">
          @if (loading()) {
            <div class="flex align-items-center justify-content-between">
              <div class="flex-1">
                <p-skeleton width="60%" styleClass="mb-2" />
                <p-skeleton width="50%" height="2rem" />
              </div>
              <p-skeleton shape="circle" size="3rem" />
            </div>
          } @else {
            <div class="flex align-items-center justify-content-between">
              <div>
                <span class="block text-color-secondary mb-2">Inventory Restored</span>
                <span class="text-3xl font-bold text-green-500">{{ summary()?.totalInventoryRestored || 0 }}</span>
              </div>
              <div class="w-3rem h-3rem border-circle bg-green-100 flex align-items-center justify-content-center">
                <i class="pi pi-check-circle text-green-500 text-xl"></i>
              </div>
            </div>
          }
        </p-card>
      </div>
    </div>
  </div>

  <!-- Refunds Table -->
  <div class="col-12">
    <p-card>
      <!-- Date Range Filter -->
      <div class="flex flex-column md:flex-row md:align-items-center gap-3 mb-4">
        <div class="flex align-items-center gap-2">
          <label for="startDate" class="font-medium white-space-nowrap">From:</label>
          <p-datepicker
            id="startDate"
            [(ngModel)]="startDate"
            (onSelect)="onDateFilterChange()"
            (onClear)="onDateFilterChange()"
            [showClear]="true"
            dateFormat="yy-mm-dd"
            placeholder="Start date"
            [showIcon]="true"
            styleClass="w-full md:w-12rem"
          />
        </div>
        <div class="flex align-items-center gap-2">
          <label for="endDate" class="font-medium white-space-nowrap">To:</label>
          <p-datepicker
            id="endDate"
            [(ngModel)]="endDate"
            (onSelect)="onDateFilterChange()"
            (onClear)="onDateFilterChange()"
            [showClear]="true"
            dateFormat="yy-mm-dd"
            placeholder="End date"
            [showIcon]="true"
            styleClass="w-full md:w-12rem"
          />
        </div>
        @if (hasActiveFilters()) {
          <p-button
            label="Clear Filters"
            icon="pi pi-filter-slash"
            severity="secondary"
            [text]="true"
            (onClick)="clearFilters()"
          />
        }
      </div>

      <!-- Table -->
      <p-table
        [value]="refunds()"
        [loading]="loading()"
        [paginator]="true"
        [rows]="10"
        [rowsPerPageOptions]="[10, 25, 50]"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} refunds"
        [rowHover]="true"
        dataKey="id"
        styleClass="p-datatable-sm"
        [sortField]="'refundDate'"
        [sortOrder]="-1"
        [scrollable]="true"
        scrollDirection="horizontal"
        [tableStyle]="{ 'min-width': '60rem' }"
      >
        <ng-template #header>
          <tr>
            <th pSortableColumn="refundNumber" style="width: 12%">
              Refund #
              <p-sortIcon field="refundNumber" />
            </th>
            <th pSortableColumn="originalReceiptNumber" style="width: 12%">
              Original Receipt
              <p-sortIcon field="originalReceiptNumber" />
            </th>
            <th style="width: 8%">Type</th>
            <th pSortableColumn="refundAmount" style="width: 10%">
              Amount
              <p-sortIcon field="refundAmount" />
            </th>
            <th pSortableColumn="itemCount" style="width: 8%">
              Items
              <p-sortIcon field="itemCount" />
            </th>
            <th pSortableColumn="customerName" style="width: 14%">
              Customer
              <p-sortIcon field="customerName" />
            </th>
            <th pSortableColumn="refundReason" style="width: 14%">
              Reason
              <p-sortIcon field="refundReason" />
            </th>
            <th pSortableColumn="refundDate" style="width: 10%">
              Date
              <p-sortIcon field="refundDate" />
            </th>
            <th style="width: 12%" alignFrozen="right" pFrozenColumn [frozen]="true">Actions</th>
          </tr>
        </ng-template>

        <ng-template #body let-refund>
          <tr>
            <td>
              <span class="font-medium text-primary">{{ refund.refundNumber }}</span>
            </td>
            <td>
              @if (refund.originalReceiptNumber) {
                <a
                  [routerLink]="['/admin/receipts']"
                  [queryParams]="{ receiptNumber: refund.originalReceiptNumber }"
                  class="text-primary no-underline hover:underline cursor-pointer"
                >
                  {{ refund.originalReceiptNumber }}
                </a>
              } @else {
                <span class="text-color-secondary">-</span>
              }
            </td>
            <td>
              <div class="flex align-items-center gap-2">
                @if (refund.isPartialRefund) {
                  <p-tag severity="warn" value="Partial" [rounded]="true" />
                } @else {
                  <p-tag severity="info" value="Full" [rounded]="true" />
                }
                @if (refund.hasCustomPrices) {
                  <p-tag
                    severity="secondary"
                    value="Custom"
                    [rounded]="true"
                    pTooltip="Custom return prices applied"
                    tooltipPosition="top"
                  />
                }
                @if (refund.managerApproved) {
                  <i
                    class="pi pi-verified text-green-500"
                    pTooltip="Manager approved"
                    tooltipPosition="top"
                  ></i>
                }
              </div>
            </td>
            <td>
              <span class="font-semibold text-red-500">{{ refund.refundAmount | appCurrency:'1.2-2' }}</span>
            </td>
            <td>
              <div class="flex align-items-center gap-2">
                <span>{{ refund.itemCount }}</span>
                @if (refund.inventoryRestoredCount > 0) {
                  <p-tag
                    severity="success"
                    [value]="refund.inventoryRestoredCount + ' restored'"
                    [rounded]="true"
                    pTooltip="Items returned to inventory"
                    tooltipPosition="top"
                  />
                }
              </div>
            </td>
            <td>
              @if (refund.customerName) {
                {{ refund.customerName }}
              } @else {
                <span class="text-color-secondary">-</span>
              }
            </td>
            <td>
              @if (refund.refundReason) {
                <span
                  class="max-w-10rem overflow-hidden text-overflow-ellipsis white-space-nowrap block"
                  [pTooltip]="refund.refundReason"
                  tooltipPosition="top"
                >
                  {{ refund.refundReason }}
                </span>
              } @else {
                <span class="text-color-secondary">-</span>
              }
            </td>
            <td>{{ refund.refundDate | date:'mediumDate' }}</td>
            <td alignFrozen="right" pFrozenColumn [frozen]="true">
              <div class="flex align-items-center gap-1">
                <p-button
                  icon="pi pi-print"
                  [rounded]="true"
                  [text]="true"
                  severity="secondary"
                  size="small"
                  pTooltip="Print Refund Receipt"
                  tooltipPosition="top"
                  (onClick)="onPrintRefund(refund)"
                />
                <p-button
                  icon="pi pi-eye"
                  [rounded]="true"
                  [text]="true"
                  severity="info"
                  size="small"
                  pTooltip="View Details"
                  tooltipPosition="top"
                  (onClick)="onViewDetails(refund)"
                />
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template #footer>
          @if (refunds().length > 0) {
            <tr>
              <td class="font-bold">Totals</td>
              <td></td>
              <td></td>
              <td class="font-bold text-red-500">{{ summary()?.totalRefundAmount || 0 | appCurrency:'1.2-2' }}</td>
              <td class="font-bold">{{ summary()?.totalItemsRefunded || 0 }} items</td>
              <td colspan="3"></td>
              <td></td>
            </tr>
          }
        </ng-template>

        <ng-template #emptymessage>
          <tr>
            <td colspan="9" class="text-center p-4">
              <div class="flex flex-column align-items-center gap-3">
                <i class="pi pi-refresh text-4xl text-color-secondary"></i>
                @if (hasActiveFilters()) {
                  <span class="text-color-secondary">No refunds found for the selected date range</span>
                  <p-button
                    label="Clear Filters"
                    icon="pi pi-filter-slash"
                    severity="secondary"
                    (onClick)="clearFilters()"
                  />
                } @else {
                  <span class="text-color-secondary">No refunds processed yet</span>
                }
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template #loadingbody>
          @for (_ of skeletonRows; track $index) {
            <tr>
              <td><p-skeleton width="70%" /></td>
              <td><p-skeleton width="70%" /></td>
              <td><p-skeleton width="50%" /></td>
              <td><p-skeleton width="60%" /></td>
              <td><p-skeleton width="50%" /></td>
              <td><p-skeleton width="60%" /></td>
              <td><p-skeleton width="80%" /></td>
              <td><p-skeleton width="60%" /></td>
              <td><p-skeleton shape="circle" size="2rem" /></td>
            </tr>
          }
        </ng-template>
      </p-table>
    </p-card>
  </div>
</div>

<!-- Refund Details Dialog -->
<p-dialog
  [(visible)]="showDetailsDialog"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  header="Refund Details"
  [style]="{ width: '650px' }"
>
  @if (selectedRefund()) {
    <div class="grid">
      <div class="col-6">
        <label class="block text-color-secondary mb-1">Refund Number</label>
        <span class="font-bold">{{ selectedRefund()?.refundNumber }}</span>
      </div>
      <div class="col-6">
        <label class="block text-color-secondary mb-1">Original Receipt</label>
        <span class="font-bold">{{ selectedRefund()?.originalReceiptNumber || '-' }}</span>
      </div>
      <div class="col-6">
        <label class="block text-color-secondary mb-1">Refund Date</label>
        <span>{{ selectedRefund()?.refundDate | date:'mediumDate' }}</span>
      </div>
      <div class="col-6">
        <label class="block text-color-secondary mb-1">Refund Time</label>
        <span>{{ selectedRefund()?.refundTime }}</span>
      </div>
      <div class="col-6">
        <label class="block text-color-secondary mb-1">Customer</label>
        <span>{{ selectedRefund()?.customerName || '-' }}</span>
        @if (selectedRefund()?.customerPhone) {
          <span class="ml-2 text-color-secondary">({{ selectedRefund()?.customerPhone }})</span>
        }
      </div>
      <div class="col-6">
        <label class="block text-color-secondary mb-1">Refund Type</label>
        <div class="flex align-items-center gap-2">
          @if (selectedRefund()?.isPartialRefund) {
            <p-tag severity="warn" value="Partial Refund" [rounded]="true" />
          } @else {
            <p-tag severity="info" value="Full Refund" [rounded]="true" />
          }
          @if (selectedRefund()?.hasCustomPrices) {
            <p-tag severity="secondary" value="Custom Prices" [rounded]="true" />
          }
        </div>
      </div>
      @if (selectedRefund()?.managerApproved) {
        <div class="col-12">
          <div class="surface-100 border-round p-3 flex align-items-center gap-2">
            <i class="pi pi-verified text-green-500 text-xl"></i>
            <div>
              <span class="font-medium text-green-700">Manager Approved</span>
              @if (selectedRefund()?.managerApprovalReason) {
                <span class="text-color-secondary ml-2">- {{ selectedRefund()?.managerApprovalReason }}</span>
              }
            </div>
          </div>
        </div>
      }
      <div class="col-12">
        <label class="block text-color-secondary mb-1">Reason</label>
        <span>{{ selectedRefund()?.refundReason || '-' }}</span>
      </div>
      <div class="col-12 mt-3">
        <label class="block text-color-secondary mb-2">Items Refunded</label>
        <div class="surface-100 border-round p-3">
          @for (item of selectedRefund()?.items; track item.id) {
            <div class="flex justify-content-between align-items-center py-2 border-bottom-1 surface-border">
              <div class="flex align-items-center gap-2">
                <span class="font-medium">{{ item.itemName }}</span>
                @if (item.inventoryRestored) {
                  <p-tag severity="success" value="Restored" [rounded]="true" />
                }
                @if (item.isCustomPrice) {
                  <p-tag severity="warn" value="Custom" [rounded]="true" pTooltip="Custom return price" tooltipPosition="top" />
                }
              </div>
              <div class="text-right">
                <span class="font-bold">{{ item.total | appCurrency:'1.2-2' }}</span>
                @if (item.isCustomPrice && item.originalUnitPrice) {
                  <div class="text-xs text-color-secondary">
                    Original: {{ item.originalUnitPrice | appCurrency:'1.2-2' }}
                    @if (item.priceDifference && item.priceDifference !== 0) {
                      <span [class]="item.priceDifference > 0 ? 'text-green-500' : 'text-red-500'">
                        ({{ item.priceDifference > 0 ? '+' : '' }}{{ item.priceDifference | appCurrency:'1.2-2' }})
                      </span>
                    }
                  </div>
                }
              </div>
            </div>
          }
          <div class="flex justify-content-between align-items-center pt-3">
            <span class="font-bold">Total Refund</span>
            <span class="font-bold text-xl text-red-500">{{ selectedRefund()?.refundAmount | appCurrency:'1.2-2' }}</span>
          </div>
        </div>
      </div>
      @if (selectedRefund()?.notes) {
        <div class="col-12">
          <label class="block text-color-secondary mb-1">Notes</label>
          <span>{{ selectedRefund()?.notes }}</span>
        </div>
      }
    </div>
  }
  <ng-template pTemplate="footer">
    <p-button
      label="Print Receipt"
      icon="pi pi-print"
      severity="secondary"
      (onClick)="onPrintRefund(selectedRefund()!); showDetailsDialog = false"
    />
    <p-button
      label="Close"
      severity="secondary"
      [text]="true"
      (onClick)="showDetailsDialog = false"
    />
  </ng-template>
</p-dialog>

<!-- Print Refund Receipt Dialog -->
<app-print-refund-receipt-dialog
  [refund]="printRefund()"
  [visible]="showPrintDialog()"
  (visibleChange)="showPrintDialog.set($event)"
/>
