<p-dialog
  [(visible)]="visible"
  (visibleChange)="onVisibleChange($event)"
  [modal]="true"
  [closable]="!processing()"
  [draggable]="false"
  [resizable]="false"
  [header]="dialogHeader"
  [style]="{ width: '650px' }"
>
  @if (checkingRefundable()) {
    <!-- Loading State -->
    <div class="flex flex-column align-items-center justify-content-center py-5">
      <p-progressSpinner [style]="{ width: '50px', height: '50px' }" />
      <span class="mt-3 text-color-secondary">Checking receipt...</span>
    </div>
  } @else if (refundableInfo()?.canRefund === false) {
    <!-- Cannot Refund State -->
    <div class="flex flex-column align-items-center gap-3 py-4">
      <i class="pi pi-times-circle text-6xl text-red-500"></i>
      <span class="text-xl font-medium">Cannot Process Refund</span>
      <p-message severity="error" [text]="refundableInfo()?.reason || 'Unknown error'" />
      @if (refundableInfo()?.existingRefundNumber) {
        <div class="text-color-secondary">
          Existing refund: <span class="font-bold">{{ refundableInfo()?.existingRefundNumber }}</span>
        </div>
      }
    </div>
  } @else if (refundableInfo()?.canRefund && !refundProcessed()) {
    <!-- Refund Form State -->
    <div class="grid">
      <!-- Receipt Info -->
      <div class="col-12 mb-3">
        <div class="surface-100 border-round p-3">
          <div class="flex justify-content-between align-items-center mb-2">
            <span class="text-color-secondary">Receipt Number</span>
            <span class="font-bold">{{ refundableInfo()?.receiptNumber }}</span>
          </div>
          <div class="flex justify-content-between align-items-center mb-2">
            <span class="text-color-secondary">Transaction Date</span>
            <span>{{ refundableInfo()?.transactionDate | date:'mediumDate' }}</span>
          </div>
          <div class="flex justify-content-between align-items-center">
            <span class="text-color-secondary">Customer</span>
            <span>{{ refundableInfo()?.customerName || 'Walk-in Customer' }}</span>
          </div>
        </div>
      </div>

      <!-- Items to Refund -->
      <div class="col-12">
        <label class="block font-medium mb-2">Items to Refund (Full Refund)</label>
        <div class="surface-100 border-round p-3">
          @for (item of refundableInfo()?.items; track item.id) {
            <div class="flex justify-content-between align-items-center py-2 border-bottom-1 surface-border">
              <div class="flex align-items-center gap-2">
                <span>{{ item.itemName }}</span>
                @if (item.canRestoreInventory) {
                  <p-tag severity="info" value="Will restore inventory" [rounded]="true" />
                }
              </div>
              <span class="font-medium">{{ item.total | appCurrency:'1.2-2' }}</span>
            </div>
          }

          <p-divider />

          <div class="flex justify-content-between align-items-center">
            <span>Subtotal</span>
            <span>{{ refundableInfo()?.subtotal | appCurrency:'1.2-2' }}</span>
          </div>
          @if ((refundableInfo()?.taxAmount ?? 0) > 0) {
            <div class="flex justify-content-between align-items-center mt-2">
              <span>Tax ({{ refundableInfo()?.taxRate }}%)</span>
              <span>{{ refundableInfo()?.taxAmount | appCurrency:'1.2-2' }}</span>
            </div>
          }
          <div class="flex justify-content-between align-items-center mt-3 pt-2 border-top-1 surface-border">
            <span class="font-bold text-lg">Total Refund Amount</span>
            <span class="font-bold text-xl text-red-500">{{ refundableInfo()?.grandTotal | appCurrency:'1.2-2' }}</span>
          </div>
        </div>
      </div>

      <!-- Refund Reason -->
      <div class="col-12 mt-3">
        <label for="refundReason" class="block font-medium mb-2">Refund Reason</label>
        <textarea
          pInputTextarea
          id="refundReason"
          [(ngModel)]="refundReason"
          [rows]="2"
          [maxlength]="500"
          placeholder="Enter reason for refund (optional)"
          class="w-full"
        ></textarea>
        <small class="text-color-secondary">{{ refundReason.length }}/500 characters</small>
      </div>

      <!-- Notes -->
      <div class="col-12">
        <label for="notes" class="block font-medium mb-2">Notes</label>
        <textarea
          pInputTextarea
          id="notes"
          [(ngModel)]="notes"
          [rows]="2"
          [maxlength]="2000"
          placeholder="Additional notes (optional)"
          class="w-full"
        ></textarea>
      </div>

      <!-- Inventory Restoration Notice -->
      @if (itemsWithInventoryRestore > 0) {
        <div class="col-12">
          <p-message
            severity="info"
            [text]="itemsWithInventoryRestore + ' item(s) will be restored to inventory'"
          />
        </div>
      }
    </div>
  } @else if (refundProcessed()) {
    <!-- Success State -->
    <div class="flex flex-column align-items-center gap-4 py-4">
      <i class="pi pi-check-circle text-6xl text-green-500"></i>
      <span class="text-xl font-medium">Refund Processed Successfully</span>

      <div class="surface-100 border-round p-4 w-full">
        <div class="flex justify-content-between align-items-center mb-2">
          <span class="text-color-secondary">Refund Number</span>
          <span class="font-bold text-primary">{{ refundResult()?.refundNumber }}</span>
        </div>
        <div class="flex justify-content-between align-items-center mb-2">
          <span class="text-color-secondary">Amount Refunded</span>
          <span class="font-bold text-red-500">{{ refundResult()?.refundAmount | appCurrency:'1.2-2' }}</span>
        </div>
        <div class="flex justify-content-between align-items-center mb-2">
          <span class="text-color-secondary">Items Refunded</span>
          <span class="font-bold">{{ refundResult()?.itemsRefunded }}</span>
        </div>
        <div class="flex justify-content-between align-items-center">
          <span class="text-color-secondary">Inventory Restored</span>
          <span class="font-bold text-green-500">{{ refundResult()?.inventoryRestored }} item(s)</span>
        </div>
      </div>
    </div>
  }

  <ng-template pTemplate="footer">
    @if (!checkingRefundable() && refundableInfo()?.canRefund === false) {
      <p-button
        label="Close"
        severity="secondary"
        (onClick)="onClose()"
      />
    } @else if (!checkingRefundable() && refundableInfo()?.canRefund && !refundProcessed()) {
      <p-button
        label="Cancel"
        severity="secondary"
        [text]="true"
        [disabled]="processing()"
        (onClick)="onClose()"
      />
      <p-button
        label="Process Full Refund"
        icon="pi pi-refresh"
        severity="danger"
        [loading]="processing()"
        (onClick)="onProcessRefund()"
      />
    } @else if (refundProcessed()) {
      <p-button
        label="Print Refund Receipt"
        icon="pi pi-print"
        severity="secondary"
        (onClick)="onPrintRefund()"
      />
      <p-button
        label="Close"
        (onClick)="onClose()"
      />
    }
  </ng-template>
</p-dialog>
