<div class="grid">
  <div class="col-12 flex align-items-center justify-content-between mb-4">
    <h1 class="text-3xl font-bold m-0">Messages</h1>
    @if (unreadCount() > 0) {
      <span class="text-color-secondary text-sm">{{ unreadCount() }} unread</span>
    }
  </div>

  <div class="col-12">
    <p-card>
      <p-table
        [value]="messages()"
        [loading]="loading()"
        [paginator]="true"
        [rows]="10"
        [rowsPerPageOptions]="[10, 25, 50]"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} messages"
        [rowHover]="true"
        dataKey="id"
        [expandedRowKeys]="expandedRows"
        styleClass="p-datatable-sm"
        [sortField]="'createdAt'"
        [sortOrder]="-1"
        [scrollable]="true"
        scrollDirection="horizontal"
        [tableStyle]="{ 'min-width': '60rem' }"
      >
        <ng-template #header>
          <tr>
            <th style="width: 3rem"></th>
            <th pSortableColumn="name" style="width: 15%">
              Name
              <p-sortIcon field="name" />
            </th>
            <th pSortableColumn="email" style="width: 18%">
              Email
              <p-sortIcon field="email" />
            </th>
            <th style="width: 12%">Phone</th>
            <th style="width: 25%">Message</th>
            <th pSortableColumn="createdAt" style="width: 13%">
              Date
              <p-sortIcon field="createdAt" />
            </th>
            <th style="width: 7%">Status</th>
            <th style="width: 10%" alignFrozen="right" pFrozenColumn [frozen]="true">Actions</th>
          </tr>
        </ng-template>

        <ng-template #body let-message let-expanded="expanded">
          <tr [class.font-bold]="!message.isRead">
            <td>
              <p-button
                type="button"
                [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                [rounded]="true"
                [text]="true"
                severity="secondary"
                size="small"
                [pRowToggler]="message"
                pTooltip="Expand message"
                tooltipPosition="top"
              />
            </td>
            <td>
              <div class="flex align-items-center gap-2">
                @if (!message.isRead) {
                  <i class="pi pi-circle-fill text-primary" style="font-size: 0.5rem"></i>
                }
                <span>{{ message.name }}</span>
              </div>
            </td>
            <td>
              <a [href]="'mailto:' + message.email" class="text-primary no-underline hover:underline">
                {{ message.email }}
              </a>
            </td>
            <td>
              @if (message.phone) {
                {{ message.phone }}
              } @else {
                <span class="text-color-secondary">-</span>
              }
            </td>
            <td>
              <span class="text-color-secondary">{{ message.messagePreview }}</span>
            </td>
            <td>{{ message.createdAt | date:'medium' }}</td>
            <td>
              <p-tag
                [value]="message.isRead ? 'Read' : 'Unread'"
                [severity]="message.isRead ? 'secondary' : 'info'"
              />
            </td>
            <td alignFrozen="right" pFrozenColumn [frozen]="true">
              <div class="flex align-items-center gap-1">
                <p-button
                  [icon]="message.isRead ? 'pi pi-envelope' : 'pi pi-check'"
                  [rounded]="true"
                  [text]="true"
                  [severity]="message.isRead ? 'warn' : 'success'"
                  size="small"
                  [pTooltip]="message.isRead ? 'Mark as Unread' : 'Mark as Read'"
                  tooltipPosition="top"
                  [loading]="togglingId() === message.id"
                  (onClick)="onToggleReadStatus(message)"
                />
                <p-button
                  icon="pi pi-trash"
                  [rounded]="true"
                  [text]="true"
                  severity="danger"
                  size="small"
                  pTooltip="Delete"
                  tooltipPosition="top"
                  (onClick)="onDelete(message)"
                />
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template #rowexpansion let-message>
          <tr>
            <td colspan="8">
              <div class="p-3 surface-ground border-round">
                <div class="flex flex-column gap-2">
                  @if (message.subject) {
                    <div>
                      <span class="font-semibold text-color-secondary">Subject: </span>
                      <span>{{ message.subject }}</span>
                    </div>
                  }
                  <div>
                    <span class="font-semibold text-color-secondary">Full Message:</span>
                    <p class="mt-2 mb-0 line-height-3 white-space-pre-line">{{ message.message }}</p>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template #emptymessage>
          <tr>
            <td colspan="8" class="text-center p-4">
              <div class="flex flex-column align-items-center gap-3">
                <i class="pi pi-envelope text-4xl text-color-secondary"></i>
                <span class="text-color-secondary">No messages found</span>
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template #loadingbody>
          @for (_ of skeletonRows; track $index) {
            <tr>
              <td><p-skeleton shape="circle" size="2rem" /></td>
              <td><p-skeleton width="70%" /></td>
              <td><p-skeleton width="80%" /></td>
              <td><p-skeleton width="50%" /></td>
              <td><p-skeleton width="90%" /></td>
              <td><p-skeleton width="60%" /></td>
              <td><p-skeleton width="3rem" height="1.5rem" borderRadius="1rem" /></td>
              <td>
                <div class="flex gap-1">
                  <p-skeleton shape="circle" size="2rem" />
                  <p-skeleton shape="circle" size="2rem" />
                </div>
              </td>
            </tr>
          }
        </ng-template>
      </p-table>
    </p-card>
  </div>
</div>
