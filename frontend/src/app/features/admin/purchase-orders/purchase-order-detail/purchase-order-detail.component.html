<div class="grid">
  <!-- Back to PO List Link -->
  <div class="col-12 mb-3">
    <p-button
      icon="pi pi-arrow-left"
      label="Back to Purchase Orders"
      [text]="true"
      (onClick)="goBackToList()"
    />
  </div>

  @if (loading()) {
    <!-- Loading Skeleton -->
    <div class="col-12">
      <p-card>
        <div class="grid">
          <div class="col-12 md:col-6">
            <p-skeleton width="60%" height="2rem" styleClass="mb-3" />
            <p-skeleton width="40%" height="1.5rem" styleClass="mb-2" />
            <p-skeleton width="50%" height="1.5rem" styleClass="mb-2" />
            <p-skeleton width="30%" height="1.5rem" />
          </div>
          <div class="col-12 md:col-6">
            <p-skeleton width="40%" height="1.5rem" styleClass="mb-2" />
            <p-skeleton width="35%" height="1.5rem" styleClass="mb-2" />
            <p-skeleton width="45%" height="1.5rem" />
          </div>
        </div>
      </p-card>
    </div>
    <div class="col-12">
      <p-card header="Line Items">
        <p-skeleton height="200px" />
      </p-card>
    </div>
  } @else if (notFound()) {
    <!-- PO Not Found -->
    <div class="col-12">
      <p-card>
        <div class="text-center py-8">
          <i class="pi pi-exclamation-circle text-6xl text-orange-500 mb-4" style="display: block;"></i>
          <h2 class="text-2xl font-bold text-900 m-0 mb-2">Purchase Order Not Found</h2>
          <p class="text-600 text-lg m-0 mb-4">
            The purchase order you're looking for doesn't exist or has been removed.
          </p>
          <p-button
            icon="pi pi-arrow-left"
            label="Back to Purchase Orders"
            (onClick)="goBackToList()"
          />
        </div>
      </p-card>
    </div>
  } @else if (purchaseOrder()) {
    <!-- PO Detail Header -->
    <div class="col-12">
      <p-card>
        <div class="flex flex-column md:flex-row md:align-items-start md:justify-content-between gap-4">
          <!-- Left Section: PO Info -->
          <div class="flex-grow-1">
            <div class="flex align-items-center gap-3 mb-3">
              <h1 class="text-3xl font-bold text-900 m-0">{{ purchaseOrder()!.poNumber }}</h1>
              <p-tag
                [value]="getStatusLabel(purchaseOrder()!.status)"
                [severity]="getStatusSeverity(purchaseOrder()!.status)"
                [rounded]="true"
                styleClass="text-sm px-3 py-1"
              />
            </div>

            <div class="grid">
              <div class="col-12 md:col-6 lg:col-3">
                <div class="flex align-items-center gap-2 mb-1">
                  <i class="pi pi-building text-primary"></i>
                  <span class="text-600 text-sm">Supplier</span>
                </div>
                <span class="text-900 font-semibold">{{ purchaseOrder()!.supplierName }}</span>
              </div>

              <div class="col-12 md:col-6 lg:col-3">
                <div class="flex align-items-center gap-2 mb-1">
                  <i class="pi pi-calendar text-primary"></i>
                  <span class="text-600 text-sm">Order Date</span>
                </div>
                <span class="text-900 font-semibold">{{ formatDate(purchaseOrder()!.orderDate) }}</span>
              </div>

              <div class="col-12 md:col-6 lg:col-3">
                <div class="flex align-items-center gap-2 mb-1">
                  <i class="pi pi-box text-primary"></i>
                  <span class="text-600 text-sm">Total Units</span>
                </div>
                <span class="text-900 font-semibold">{{ getTotalUnits() }} unit{{ getTotalUnits() !== 1 ? 's' : '' }}</span>
              </div>

              <div class="col-12 md:col-6 lg:col-3">
                <div class="flex align-items-center gap-2 mb-1">
                  <i class="pi pi-dollar text-primary"></i>
                  <span class="text-600 text-sm">Total Amount</span>
                </div>
                <span class="text-2xl font-bold text-primary">
                  {{ purchaseOrder()!.totalAmount | appCurrency:'1.2-2' }}
                </span>
              </div>
            </div>

            @if (purchaseOrder()!.notes) {
              <div class="mt-4">
                <div class="flex align-items-center gap-2 mb-1">
                  <i class="pi pi-file-edit text-primary"></i>
                  <span class="text-600 text-sm">Notes</span>
                </div>
                <p class="text-900 m-0 line-height-3">{{ purchaseOrder()!.notes }}</p>
              </div>
            }
          </div>

          <!-- Right Section: Action Buttons -->
          <div class="flex flex-column gap-2" style="min-width: 180px;">
            @if (isPending()) {
              <p-button
                icon="pi pi-box"
                label="Receive Order"
                severity="success"
                styleClass="w-full"
                (onClick)="openReceivingDialog()"
                [loading]="actionLoading()"
                pTooltip="Receive this order and create inventory"
                tooltipPosition="left"
              />
              <p-button
                icon="pi pi-times"
                label="Cancel Order"
                severity="danger"
                [outlined]="true"
                styleClass="w-full"
                (onClick)="cancelOrder()"
                [loading]="actionLoading()"
                pTooltip="Cancel this purchase order"
                tooltipPosition="left"
              />
            } @else {
              <div class="text-center p-3 border-round" [ngClass]="isReceived() ? 'bg-green-50' : 'bg-red-50'">
                <i class="pi mb-2" style="font-size: 1.5rem; display: block;"
                   [ngClass]="isReceived() ? 'pi-check-circle text-green-500' : 'pi-times-circle text-red-500'"></i>
                <span class="text-sm" [ngClass]="isReceived() ? 'text-green-700' : 'text-red-700'">
                  @if (isReceived()) {
                    Order received successfully
                  } @else if (isCancelled()) {
                    Order has been cancelled
                  }
                </span>
              </div>
              @if (isReceived()) {
                <p-button
                  icon="pi pi-list"
                  label="View Inventory"
                  severity="secondary"
                  [text]="true"
                  styleClass="w-full mt-2"
                  (onClick)="navigateToInventory()"
                  pTooltip="Browse phones in inventory"
                  tooltipPosition="left"
                />
              }
            }
          </div>
        </div>
      </p-card>
    </div>

    <!-- Line Items Table -->
    <div class="col-12">
      <p-card header="Line Items">
        <ng-template pTemplate="subtitle">
          <span class="text-600 text-sm">
            {{ getTotalUnits() }} total unit{{ getTotalUnits() > 1 ? 's' : '' }} across {{ purchaseOrder()!.items.length }} line item{{ purchaseOrder()!.items.length > 1 ? 's' : '' }}
          </span>
        </ng-template>
        <p-table
          [value]="purchaseOrder()!.items"
          [scrollable]="true"
          scrollDirection="horizontal"
          [tableStyle]="{ 'min-width': '50rem' }"
          styleClass="p-datatable-striped"
        >
          <ng-template pTemplate="header">
            <tr>
              <th style="width: 5%">#</th>
              <th style="width: 25%">Brand</th>
              <th style="width: 30%">Model</th>
              <th style="width: 12%" class="text-right">Quantity</th>
              <th style="width: 14%" class="text-right">Unit Cost</th>
              <th style="width: 14%" class="text-right">Line Total</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item let-rowIndex="rowIndex">
            <tr>
              <td class="text-600">{{ rowIndex + 1 }}</td>
              <td>
                <span class="font-semibold">{{ item.brand }}</span>
              </td>
              <td>{{ item.model }}</td>
              <td class="text-right">
                <span class="font-medium">{{ item.quantity }}</span>
              </td>
              <td class="text-right">
                {{ item.unitCost | appCurrency:'1.2-2' }}
              </td>
              <td class="text-right font-semibold">
                {{ item.lineTotal | appCurrency:'1.2-2' }}
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="footer">
            <tr>
              <td colspan="5" class="text-right font-bold text-lg">
                Order Total:
              </td>
              <td class="text-right font-bold text-lg text-primary">
                {{ purchaseOrder()!.totalAmount | appCurrency:'1.2-2' }}
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="6" class="text-center py-4">
                <span class="text-600">No line items found</span>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </p-card>
    </div>

    <!-- Order Metadata -->
    <div class="col-12">
      <p-card>
        <div class="flex flex-wrap gap-4 text-sm text-600">
          <div class="flex align-items-center gap-2">
            <i class="pi pi-clock"></i>
            <span>Created: {{ formatDateTime(purchaseOrder()!.createdAt) }}</span>
          </div>
          @if (purchaseOrder()!.updatedAt) {
            <div class="flex align-items-center gap-2">
              <i class="pi pi-refresh"></i>
              <span>Last Updated: {{ formatDateTime(purchaseOrder()!.updatedAt!) }}</span>
            </div>
          }
        </div>
      </p-card>
    </div>
  }
</div>

<!-- Receiving Dialog -->
@if (showReceivingDialog()) {
  <app-purchase-order-receiving
    [purchaseOrder]="purchaseOrder()"
    (closed)="onReceivingDialogClosed()"
    (received)="onOrderReceived($event)"
  />
}
