<p-dialog
  [(visible)]="visible"
  [modal]="true"
  [closable]="!saving()"
  [draggable]="false"
  [resizable]="false"
  [focusOnShow]="true"
  [focusTrap]="true"
  [closeOnEscape]="true"
  [style]="{ width: '90vw', maxWidth: '1200px' }"
  [contentStyle]="{ 'max-height': '80vh', 'overflow-y': 'auto' }"
  header="Receive Purchase Order"
  (onShow)="onDialogShow()"
  (onHide)="onDialogHide()"
  role="dialog"
  aria-label="Receive Purchase Order"
>
  @if (purchaseOrder) {
    <!-- PO Header Info -->
    <div class="surface-50 border-round p-3 mb-4">
      <div class="flex flex-wrap gap-4 align-items-center justify-content-between">
        <div class="flex flex-wrap gap-4 align-items-center">
          <div>
            <span class="text-600 text-sm block">PO Number</span>
            <span class="font-bold text-900 text-lg">{{ purchaseOrder.poNumber }}</span>
          </div>
          <p-divider layout="vertical" styleClass="hidden md:block" />
          <div>
            <span class="text-600 text-sm block">Supplier</span>
            <span class="font-semibold text-900">{{ purchaseOrder.supplierName }}</span>
          </div>
          <p-divider layout="vertical" styleClass="hidden md:block" />
          <div>
            <span class="text-600 text-sm block">Total Units</span>
            <span class="font-bold text-primary text-lg">{{ totalUnits() }}</span>
          </div>
        </div>
        @if (totalUnits() > 1) {
          <p-button
            label="Quick Fill"
            icon="pi pi-bolt"
            severity="secondary"
            [outlined]="true"
            size="small"
            (onClick)="quickFillMenu.toggle($event)"
            pTooltip="Apply values to all products"
          />
          <p-menu #quickFillMenu [model]="quickFillMenuItems" [popup]="true" appendTo="body" />
        }
      </div>
    </div>

    <!-- Instructions -->
    <div class="flex align-items-center gap-2 text-600 text-sm mb-4 p-3 surface-ground border-round">
      <i class="pi pi-info-circle text-primary"></i>
      <span>Fill in the details for each product unit. Required fields are marked with <span class="text-red-500">*</span>. Brand and model are pre-filled from the PO.</span>
    </div>

    <p-accordion [multiple]="true" [value]="activeAccordionValues()">
      @for (item of purchaseOrder.items; track item.id; let itemIdx = $index) {
        <p-accordion-panel [value]="itemIdx.toString()">
          <p-accordion-header>
            <div class="flex flex-column sm:flex-row sm:align-items-center sm:justify-content-between gap-2 w-full pr-3">
              <div class="flex align-items-center gap-2 flex-wrap">
                <span class="font-bold text-900">{{ item.brand }} {{ item.model }}</span>
                <p-tag
                  [value]="item.quantity + ' unit' + (item.quantity > 1 ? 's' : '')"
                  severity="info"
                  [rounded]="true"
                />
                @if (getLineItemValidCount(itemIdx) === item.quantity) {
                  <i class="pi pi-check-circle text-green-500" pTooltip="All units ready"></i>
                } @else {
                  <span class="text-orange-500 text-sm">
                    {{ getLineItemValidCount(itemIdx) }}/{{ item.quantity }} ready
                  </span>
                }
              </div>
              <div class="flex align-items-center gap-3">
                <span class="text-600 text-sm">
                  Cost: {{ item.unitCost | appCurrency:'1.2-2' }} each
                </span>
                @if (item.quantity > 1) {
                  <p-button
                    icon="pi pi-copy"
                    severity="secondary"
                    [text]="true"
                    size="small"
                    (onClick)="copyFirstToRest(itemIdx, $event)"
                    pTooltip="Copy first unit to others"
                    tooltipPosition="left"
                  />
                }
              </div>
            </div>
          </p-accordion-header>
          <p-accordion-content>
            <div class="grid">
              @for (unitIdx of getUnitRange(item.quantity); track unitIdx) {
                @let formIdx = getFormIndex(itemIdx, unitIdx);
                <div class="col-12">
                  @if (item.quantity > 1) {
                    <div class="flex align-items-center justify-content-between mb-3">
                      <div class="flex align-items-center gap-2">
                        <span class="font-semibold text-primary">Unit {{ unitIdx + 1 }}</span>
                        @if (productsArray.at(formIdx).valid) {
                          <i class="pi pi-check-circle text-green-500 text-sm"></i>
                        } @else {
                          <i class="pi pi-exclamation-circle text-orange-500 text-sm"></i>
                        }
                      </div>
                      @if (unitIdx === 0 && item.quantity > 1) {
                        <span class="text-500 text-xs">Use copy button above to duplicate to other units</span>
                      }
                    </div>
                  }

                  <div class="grid">
                    <!-- Row 1: Condition, Selling Price, Color, IMEI -->
                    <div class="col-12 md:col-6 lg:col-3">
                      <label class="block font-medium mb-2" [for]="'condition-' + formIdx">
                        Condition <span class="text-red-500">*</span>
                      </label>
                      <p-select
                        [options]="conditionOptions"
                        [formControl]="getFormControl(formIdx, 'condition')"
                        placeholder="Select condition"
                        optionLabel="label"
                        optionValue="value"
                        styleClass="w-full"
                        appendTo="body"
                        [inputId]="'condition-' + formIdx"
                        (onChange)="onConditionChange(formIdx)"
                      />
                    </div>

                    <div class="col-12 md:col-6 lg:col-3">
                      <label class="block font-medium mb-2" [for]="'sellingPrice-' + formIdx">
                        Selling Price <span class="text-red-500">*</span>
                      </label>
                      <p-inputNumber
                        [formControl]="getFormControl(formIdx, 'sellingPrice')"
                        mode="currency"
                        currency="PKR"
                        locale="en-US"
                        [inputId]="'sellingPrice-' + formIdx"
                        styleClass="w-full"
                        placeholder="0.00"
                      />
                    </div>

                    <div class="col-12 md:col-6 lg:col-3">
                      <label class="block font-medium mb-2" [for]="'color-' + formIdx">Color</label>
                      <input
                        pInputText
                        [formControl]="getFormControl(formIdx, 'color')"
                        class="w-full"
                        placeholder="e.g., Space Gray"
                        [maxlength]="constraints.COLOR_MAX"
                        [id]="'color-' + formIdx"
                      />
                    </div>

                    <div class="col-12 md:col-6 lg:col-3">
                      <label class="block font-medium mb-2" [for]="'imei-' + formIdx">
                        IMEI
                        <i class="pi pi-info-circle text-400 ml-1" pTooltip="Each product should have a unique IMEI"></i>
                      </label>
                      <input
                        pInputText
                        [formControl]="getFormControl(formIdx, 'imei')"
                        class="w-full"
                        placeholder="15-17 digits"
                        [maxlength]="constraints.IMEI_MAX"
                        [id]="'imei-' + formIdx"
                      />
                    </div>

                    <!-- Row 2: Storage, RAM, Battery Health, Notes -->
                    <div class="col-12 md:col-6 lg:col-3">
                      <label class="block font-medium mb-2" [for]="'storageGb-' + formIdx">Storage (GB)</label>
                      <p-inputNumber
                        [formControl]="getFormControl(formIdx, 'storageGb')"
                        [inputId]="'storageGb-' + formIdx"
                        styleClass="w-full"
                        placeholder="e.g., 128"
                        [min]="0"
                      />
                    </div>

                    <div class="col-12 md:col-6 lg:col-3">
                      <label class="block font-medium mb-2" [for]="'ramGb-' + formIdx">RAM (GB)</label>
                      <p-inputNumber
                        [formControl]="getFormControl(formIdx, 'ramGb')"
                        [inputId]="'ramGb-' + formIdx"
                        styleClass="w-full"
                        placeholder="e.g., 8"
                        [min]="0"
                      />
                    </div>

                    <div class="col-12 md:col-6 lg:col-3">
                      <label class="block font-medium mb-2" [for]="'batteryHealth-' + formIdx">
                        Battery Health (%)
                        <i
                          class="pi pi-info-circle ml-1"
                          [ngClass]="shouldShowBatteryHealth(formIdx) ? 'text-primary' : 'text-400'"
                          pTooltip="Applicable for used/open box products"
                        ></i>
                      </label>
                      <p-inputNumber
                        [formControl]="getFormControl(formIdx, 'batteryHealth')"
                        [inputId]="'batteryHealth-' + formIdx"
                        styleClass="w-full"
                        placeholder="0-100"
                        [min]="0"
                        [max]="100"
                      />
                    </div>

                    <div class="col-12 lg:col-3">
                      <label class="block font-medium mb-2" [for]="'notes-' + formIdx">Notes</label>
                      <textarea
                        pTextarea
                        [formControl]="getFormControl(formIdx, 'notes')"
                        rows="1"
                        class="w-full"
                        placeholder="Optional notes"
                        [maxlength]="constraints.NOTES_MAX"
                        [id]="'notes-' + formIdx"
                      ></textarea>
                    </div>
                  </div>

                  @if (unitIdx < item.quantity - 1) {
                    <p-divider />
                  }
                </div>
              }
            </div>
          </p-accordion-content>
        </p-accordion-panel>
      }
    </p-accordion>
  }

  <ng-template pTemplate="footer">
    <div class="flex flex-column sm:flex-row justify-content-between align-items-center gap-3 w-full">
      <div class="flex align-items-center gap-2">
        @if (invalidCount() > 0) {
          <i class="pi pi-exclamation-circle text-orange-500"></i>
          <span class="text-600 text-sm">{{ invalidCount() }} product(s) need required fields filled</span>
        } @else {
          <i class="pi pi-check-circle text-green-500"></i>
          <span class="text-green-600 font-medium">All {{ totalUnits() }} products ready to receive</span>
        }
      </div>
      <div class="flex gap-2">
        <p-button
          label="Cancel"
          [text]="true"
          severity="secondary"
          (onClick)="onCancel()"
          [disabled]="saving()"
        />
        <p-button
          label="Receive & Create Inventory"
          icon="pi pi-check"
          severity="success"
          (onClick)="onSubmit()"
          [loading]="saving()"
          [disabled]="!isFormValid()"
        />
      </div>
    </div>
  </ng-template>
</p-dialog>
