<div class="grid">
  <!-- Header -->
  <div class="col-12 flex align-items-center justify-content-between mb-4">
    <div class="flex align-items-center gap-3">
      <p-button
        icon="pi pi-arrow-left"
        [rounded]="true"
        [text]="true"
        severity="secondary"
        routerLink="/admin/sales"
        pTooltip="Back to Sales"
        tooltipPosition="right"
      />
      <h1 class="text-3xl font-bold m-0">New Sale</h1>
    </div>
  </div>

  <div class="col-12 lg:col-8">
    <!-- Product Search Section -->
    <p-card styleClass="mb-4">
      <ng-template pTemplate="header">
        <div class="flex align-items-center gap-2 px-4 pt-4">
          <i class="pi pi-search text-primary text-xl"></i>
          <span class="text-xl font-semibold">Search Products</span>
        </div>
      </ng-template>

      <div class="flex flex-column gap-3">
        <!-- Search with barcode scanner -->
        <div class="flex gap-2 align-items-start">
          <div class="flex-1 relative">
            <input
              #searchInput
              pInputText
              [(ngModel)]="searchQuery"
              (input)="onSearchInputChange($event)"
              (keydown.enter)="searchInput.blur()"
              placeholder="Search by product name, model, or IMEI..."
              class="w-full"
            />
            @if (searchLoading) {
              <div class="absolute right-0 top-50 mt-2 mr-3" style="transform: translateY(-50%);">
                <p-progressSpinner strokeWidth="4" styleClass="w-1rem h-1rem" />
              </div>
            }
            <!-- Search Results Dropdown -->
            @if (filteredPhones.length > 0 && showSearchResults) {
              <div class="absolute z-5 w-full mt-1 surface-border border-round shadow-3 surface-card overflow-hidden max-h-30rem overflow-y-auto">
                @for (phone of filteredPhones; track phone.id) {
                  <div
                    (click)="onProductClick(phone)"
                    class="p-3 cursor-pointer hover:surface-ground flex align-items-center gap-3 border-bottom-1 surface-border"
                  >
                    @if (phone.primaryImageUrl) {
                      <img [src]="phone.primaryImageUrl" [alt]="phone.model" width="40" height="40" class="border-round" />
                    } @else {
                      <div class="flex align-items-center justify-content-center bg-surface-200 border-round" style="width: 40px; height: 40px;">
                        <i class="pi pi-mobile text-color-secondary"></i>
                      </div>
                    }
                    <div class="flex-1">
                      <div class="font-semibold">{{ phone.brandName }} {{ phone.model }}</div>
                      <div class="text-sm text-color-secondary flex align-items-center gap-2">
                        @if (phone.storageGb) {
                          <span>{{ phone.storageGb }}GB</span>
                        }
                        @if (phone.color) {
                          <span>{{ phone.color }}</span>
                        }
                        @if (phone.imei) {
                          <span class="text-xs">IMEI: {{ phone.imei }}</span>
                        }
                      </div>
                    </div>
                    <div class="text-right">
                      <div class="font-bold text-primary">{{ phone.sellingPrice | currency }}</div>
                      <p-tag [value]="phone.status === PhoneStatus.AVAILABLE ? 'In Stock' : phone.status" [severity]="phone.status === PhoneStatus.AVAILABLE ? 'success' : 'warn'" />
                    </div>
                  </div>
                }
              </div>
            }
          </div>

          <!-- Barcode Scanner Button -->
          <app-barcode-scanner
            buttonIcon="pi pi-camera"
            buttonLabel="Scan"
            [showLabel]="!viewportService.isMobile()"
            buttonSeverity="secondary"
            [buttonOutlined]="true"
            dialogHeader="Scan Product Barcode"
            [closeOnScan]="true"
            (scanned)="onBarcodeScanned($event)"
          />
        </div>

        @if (cartItems.length === 0) {
          <p-message severity="info" text="Search and select products to add them to the cart" styleClass="w-full" />
        }
      </div>
    </p-card>

    <!-- Cart Items Section -->
    @if (cartItems.length > 0) {
      <p-card styleClass="mb-4">
        <ng-template pTemplate="header">
          <div class="flex align-items-center justify-content-between px-4 pt-4">
            <div class="flex align-items-center gap-2">
              <i class="pi pi-shopping-cart text-primary text-xl"></i>
              <span class="text-xl font-semibold">Cart Items</span>
              <p-tag [value]="cartItems.length + ' item(s)'" severity="secondary" />
            </div>
            <p-button
              label="Clear Cart"
              icon="pi pi-trash"
              severity="danger"
              [text]="true"
              size="small"
              (onClick)="onClearCart()"
            />
          </div>
        </ng-template>

        <p-table
          [value]="cartItems"
          dataKey="phoneId"
          styleClass="p-datatable-sm"
          [scrollable]="true"
          scrollDirection="horizontal"
          [tableStyle]="{ 'min-width': '40rem' }"
        >
          <ng-template #header>
            <tr>
              <th style="width: 35%">Product</th>
              <th style="width: 20%">Unit Price</th>
              <th style="width: 20%">Sale Price</th>
              <th style="width: 15%">Tax</th>
              <th style="width: 10%">Actions</th>
            </tr>
          </ng-template>

          <ng-template #body let-item let-rowIndex="rowIndex">
            <tr>
              <td>
                <div class="flex align-items-center gap-2">
                  @if (item.primaryImageUrl) {
                    <img [src]="item.primaryImageUrl" [alt]="item.model" width="40" height="40" class="border-round" />
                  } @else {
                    <div class="flex align-items-center justify-content-center bg-surface-200 border-round" style="width: 40px; height: 40px;">
                      <i class="pi pi-mobile text-color-secondary"></i>
                    </div>
                  }
                  <div>
                    <div class="font-semibold">{{ item.brandName }} {{ item.model }}</div>
                    <div class="text-sm text-color-secondary">
                      @if (item.storageGb) {
                        {{ item.storageGb }}GB
                      }
                      @if (item.color) {
                        Â· {{ item.color }}
                      }
                    </div>
                  </div>
                </div>
              </td>
              <td>
                <span class="text-color-secondary">{{ item.sellingPrice | currency }}</span>
              </td>
              <td>
                <p-inputNumber
                  [(ngModel)]="item.salePrice"
                  mode="currency"
                  currency="USD"
                  [minFractionDigits]="2"
                  [maxFractionDigits]="2"
                  [min]="0"
                  (ngModelChange)="onSalePriceChange()"
                  inputStyleClass="w-6rem"
                />
              </td>
              <!-- Tax Column (F-012) -->
              <td>
                @if (item.isTaxExempt) {
                  <p-tag value="Tax Exempt" severity="info" styleClass="text-xs" />
                } @else if (item.taxRate > 0) {
                  <div class="flex flex-column">
                    <span class="text-sm">{{ item.taxRate }}%</span>
                    <span class="text-xs text-color-secondary">{{ item.taxAmount | currency }}</span>
                    @if (item.isTaxInclusive) {
                      <span class="text-xs text-color-secondary">(incl.)</span>
                    }
                  </div>
                } @else {
                  <span class="text-color-secondary text-sm">No Tax</span>
                }
              </td>
              <td>
                <p-button
                  icon="pi pi-times"
                  [rounded]="true"
                  [text]="true"
                  severity="danger"
                  size="small"
                  (onClick)="onRemoveItem(rowIndex)"
                  pTooltip="Remove item"
                  tooltipPosition="top"
                />
              </td>
            </tr>
          </ng-template>
        </p-table>

        <!-- Inventory Warnings -->
        @if (inventoryWarnings.length > 0) {
          <div class="mt-3">
            @for (warning of inventoryWarnings; track warning.phoneId) {
              <p-message severity="warn" [text]="warning.message" styleClass="w-full mb-2" />
            }
          </div>
        }

        @if (inventoryError) {
          <p-message severity="error" [text]="inventoryError" styleClass="w-full mt-3" />
        }
      </p-card>
    }

    <!-- Customer Information Section -->
    <p-card styleClass="mb-4">
      <ng-template pTemplate="header">
        <div class="flex align-items-center justify-content-between px-4 pt-4">
          <div class="flex align-items-center gap-2">
            <i class="pi pi-user text-primary text-xl"></i>
            <span class="text-xl font-semibold">Customer Information</span>
            <p-tag value="Optional" severity="secondary" styleClass="text-xs" />
          </div>
          @if (selectedCustomer) {
            <p-tag [value]="'Existing Customer'" severity="success" />
          }
        </div>
      </ng-template>

      <div class="flex flex-column gap-4">
        <div class="grid">
          <div class="col-12 md:col-4">
            <div class="flex flex-column gap-2">
              <p-floatlabel variant="on">
                <input
                  pInputText
                  id="customerPhone"
                  [(ngModel)]="customerInfo.phone"
                  (blur)="onCustomerPhoneLookup()"
                  [maxlength]="30"
                  class="w-full"
                  [class.p-invalid]="customerLookupStatus === 'not_found'"
                />
                <label for="customerPhone">Phone Number</label>
              </p-floatlabel>
              @if (customerLookupLoading) {
                <small class="text-color-secondary flex align-items-center gap-2">
                  <p-progressSpinner strokeWidth="4" styleClass="w-1rem h-1rem" />
                  Looking up customer...
                </small>
              } @else if (customerLookupStatus === 'found') {
                <small class="text-green-500 flex align-items-center gap-1">
                  <i class="pi pi-check-circle"></i>
                  Customer found - info auto-filled
                </small>
              } @else if (customerLookupStatus === 'not_found' && customerInfo.phone.length >= 5) {
                <div class="flex align-items-center gap-2">
                  <small class="text-orange-500">New customer</small>
                  <p-button
                    label="Create Profile"
                    icon="pi pi-user-plus"
                    size="small"
                    [text]="true"
                    (onClick)="openCreateCustomerDialog()"
                  />
                </div>
              }
            </div>
          </div>
          <div class="col-12 md:col-4">
            <p-floatlabel variant="on">
              <input
                pInputText
                id="customerName"
                [(ngModel)]="customerInfo.name"
                [maxlength]="200"
                class="w-full"
              />
              <label for="customerName">Customer Name</label>
            </p-floatlabel>
          </div>
          <div class="col-12 md:col-4">
            <p-floatlabel variant="on">
              <input
                pInputText
                id="customerEmail"
                [(ngModel)]="customerInfo.email"
                type="email"
                [maxlength]="255"
                class="w-full"
              />
              <label for="customerEmail">Email Address</label>
            </p-floatlabel>
          </div>
        </div>

        @if (selectedCustomer?.notes) {
          <div class="surface-ground border-round p-3">
            <div class="flex align-items-center gap-2 mb-2">
              <i class="pi pi-info-circle text-color-secondary"></i>
              <span class="font-medium text-color-secondary">Customer Notes</span>
            </div>
            <p class="m-0 text-sm">{{ selectedCustomer!.notes }}</p>
          </div>
        }

        <p-floatlabel variant="on">
          <textarea
            pTextarea
            id="notes"
            [(ngModel)]="notes"
            [maxlength]="2000"
            rows="2"
            [autoResize]="true"
            class="w-full"
          ></textarea>
          <label for="notes">Sale notes or comments</label>
        </p-floatlabel>
      </div>
    </p-card>

    <!-- Discount Section - Feature: F-023 -->
    @if (cartItems.length > 0) {
      <p-card styleClass="mb-4">
        <ng-template pTemplate="header">
          <div class="flex align-items-center gap-2 px-4 pt-4">
            <i class="pi pi-percentage text-primary text-xl"></i>
            <span class="text-xl font-semibold">Discount & Coupons</span>
          </div>
        </ng-template>
        <app-discount-panel
          [originalPrice]="cartSummary.grandTotal"
          (discountApplied)="onDiscountApplied($event)"
          (discountRemoved)="onDiscountRemoved()"
        />
      </p-card>
    }

    <!-- Loyalty Points Section - Feature: F-022 -->
    @if (cartItems.length > 0 && selectedCustomer) {
      <app-loyalty-redemption-panel
        [customerId]="selectedCustomer!.id"
        [purchaseAmount]="cartSummary.finalTotal"
        (redemptionChange)="onLoyaltyRedemptionChange($event)"
        (enrollCustomer)="onEnrollCustomerInLoyalty()"
      />
    }

    <!-- Payment Method Section - Feature: F-018 -->
    @if (cartItems.length > 0) {
      <app-payment-method-selector
        [totalDue]="cartSummary.finalTotal"
        (paymentsChange)="onPaymentsChange($event)"
        (validationChange)="onPaymentValidationChange($event)"
      />
    }
  </div>

  <!-- Order Summary Sidebar -->
  <div class="col-12 lg:col-4">
    <div class="sticky" style="top: 1rem;">
      <p-card>
        <ng-template pTemplate="header">
          <div class="flex align-items-center gap-2 px-4 pt-4">
            <i class="pi pi-receipt text-primary text-xl"></i>
            <span class="text-xl font-semibold">Order Summary</span>
          </div>
        </ng-template>

        <div class="flex flex-column gap-3">
          <!-- Sale Date -->
          <div class="flex align-items-center gap-2">
            <label for="saleDate" class="font-medium w-6rem">Sale Date:</label>
            <p-datepicker
              id="saleDate"
              [(ngModel)]="saleDate"
              [showIcon]="true"
              [iconDisplay]="'input'"
              dateFormat="yy-mm-dd"
              styleClass="flex-1"
            />
          </div>

          <p-divider />

          <!-- Summary -->
          <div class="flex justify-content-between">
            <span class="text-color-secondary">Subtotal ({{ cartSummary.itemCount }} items)</span>
            <span class="font-medium">{{ cartSummary.subtotal | currency }}</span>
          </div>

          <div class="flex justify-content-between">
            <span class="text-color-secondary">Tax</span>
            <span class="font-medium">{{ cartSummary.taxAmount | currency }}</span>
          </div>

          <!-- Discount Display - Feature: F-023 -->
          @if (appliedDiscount) {
            <div class="flex justify-content-between text-green-500">
              <span class="flex align-items-center gap-1">
                <i class="pi pi-tag"></i>
                Discount
                @if (appliedDiscount!.couponCode) {
                  <span class="text-xs">({{ appliedDiscount!.couponCode }})</span>
                }
              </span>
              <span class="font-medium">-{{ appliedDiscount!.discountAmount | currency }}</span>
            </div>
          }

          <!-- Loyalty Points Redemption Display - Feature: F-022 -->
          @if (loyaltyRedemption) {
            <div class="flex justify-content-between text-purple-500">
              <span class="flex align-items-center gap-1">
                <i class="pi pi-ticket"></i>
                Points Redeemed
                <span class="text-xs">({{ loyaltyRedemption!.points }} pts)</span>
              </span>
              <span class="font-medium">-{{ loyaltyRedemption!.discount | currency }}</span>
            </div>
          }

          <p-divider />

          <div class="flex justify-content-between">
            <span class="text-xl font-bold">Grand Total</span>
            <span class="text-xl font-bold text-primary">{{ cartSummary.finalTotal | currency }}</span>
          </div>

          @if (appliedDiscount) {
            <div class="flex justify-content-between text-xs text-color-secondary">
              <span>Original: {{ cartSummary.grandTotal | currency }}</span>
              <span class="text-green-500">You save: {{ appliedDiscount!.discountAmount | currency }}</span>
            </div>
          }

          <!-- Inventory Status Badge -->
          @if (cartItems.length > 0) {
            <div class="flex align-items-center justify-content-center gap-2 surface-ground border-round p-2">
              @if (checkingInventory) {
                <p-progressSpinner strokeWidth="4" styleClass="w-1rem h-1rem" />
                <span class="text-color-secondary text-sm">Checking inventory...</span>
              } @else if (inventoryError) {
                <i class="pi pi-exclamation-circle text-red-500"></i>
                <span class="text-red-500 text-sm">Inventory issue detected</span>
              } @else if (inventoryWarnings.length > 0) {
                <i class="pi pi-exclamation-triangle text-orange-500"></i>
                <span class="text-orange-500 text-sm">{{ inventoryWarnings.length }} warning(s)</span>
              } @else {
                <i class="pi pi-check-circle text-green-500"></i>
                <span class="text-green-500 text-sm">All items available</span>
              }
            </div>
          }

          <p-divider />

          <!-- Action Buttons -->
          <p-button
            label="Complete Sale"
            icon="pi pi-check"
            severity="success"
            styleClass="w-full"
            [loading]="saving"
            [disabled]="!isFormValid() || !!inventoryError || !paymentValidation.isValid"
            (onClick)="onCompleteSale()"
          />

          <p-button
            label="Cancel"
            icon="pi pi-times"
            severity="secondary"
            [outlined]="true"
            styleClass="w-full"
            routerLink="/admin/sales"
          />
        </div>
      </p-card>
    </div>
  </div>
</div>

<!-- Print Receipt Dialog -->
<app-print-receipt-dialog
  [receiptData]="completedReceiptData"
  [visible]="showReceiptDialog"
  (visibleChange)="onReceiptDialogClose($event)"
  (whatsAppSent)="onWhatsAppSent($event)"
/>

<!-- Create Customer Dialog -->
<app-customer-form-dialog
  [visible]="showCustomerFormDialog"
  [customer]="null"
  (visibleChange)="showCustomerFormDialog = $event"
  (saved)="onCustomerCreated($event)"
/>
