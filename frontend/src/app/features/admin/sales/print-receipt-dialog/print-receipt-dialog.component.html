<p-dialog
  [header]="dialogHeader()"
  [visible]="visible()"
  (visibleChange)="onVisibleChange($event)"
  (onShow)="onDialogShow()"
  (onHide)="onDialogHide()"
  [modal]="true"
  [closable]="true"
  [focusOnShow]="true"
  [focusTrap]="true"
  [closeOnEscape]="true"
  [style]="{ width: '900px', maxWidth: '95vw' }"
  [breakpoints]="{ '960px': '95vw' }"
  role="dialog"
  [attr.aria-label]="dialogHeader()"
  styleClass="receipt-dialog"
>
  <!-- Print Controls -->
  <div class="flex flex-column md:flex-row align-items-start md:align-items-center justify-content-between gap-3 mb-4 no-print">
    <div class="flex flex-wrap gap-2">
      <p-button
        label="Email"
        icon="pi pi-envelope"
        severity="info"
        (onClick)="onSendEmail()"
        [disabled]="!canSendEmail()"
        [loading]="emailSending()"
        [pTooltip]="emailTooltip()"
        tooltipPosition="bottom"
        ariaLabel="Send receipt via Email"
      />
      <p-button
        label="WhatsApp"
        icon="pi pi-whatsapp"
        severity="success"
        (onClick)="onSharePdf()"
        [loading]="pdfSharing()"
        pTooltip="Download PDF and open WhatsApp"
        tooltipPosition="bottom"
        ariaLabel="Send PDF via WhatsApp"
      />
      <p-button
        label="PDF"
        icon="pi pi-file-pdf"
        severity="secondary"
        (onClick)="onDownloadPdf()"
        ariaLabel="Download receipt as PDF"
      />
      <p-button
        label="Print"
        icon="pi pi-print"
        (onClick)="onPrint()"
        ariaLabel="Print receipt"
      />
    </div>
  </div>

  <!-- Email Input (shown when no customer email or manual entry requested) -->
  @if (showEmailInput()) {
    <div class="mb-4 p-3 surface-ground border-round no-print">
      <div class="flex flex-column gap-2">
        <label for="emailAddress" class="font-medium">
          <i class="pi pi-envelope text-blue-500 mr-2"></i>
          Enter customer email address
        </label>
        <div class="flex gap-2">
          <input
            pInputText
            id="emailAddress"
            [(ngModel)]="manualEmailAddress"
            placeholder="customer@example.com"
            class="flex-1"
            (keyup.enter)="onSendEmailWithManualAddress()"
            [disabled]="emailSending()"
          />
          <p-button
            icon="pi pi-send"
            severity="info"
            (onClick)="onSendEmailWithManualAddress()"
            [disabled]="!isManualEmailValid() || emailSending()"
            [loading]="emailSending()"
            ariaLabel="Send to this email"
          />
          <p-button
            icon="pi pi-times"
            severity="secondary"
            [text]="true"
            (onClick)="hideEmailInput()"
            [disabled]="emailSending()"
            ariaLabel="Cancel"
          />
        </div>
        @if (manualEmailAddress && !isManualEmailValid()) {
          <small class="text-red-500">Please enter a valid email address</small>
        }
        @if (lastEmailError()) {
          <p-message severity="error" [text]="lastEmailError()!" styleClass="mt-2" />
        }
      </div>
    </div>
  }

  <!-- Email Error with Retry -->
  @if (lastEmailError() && !showEmailInput()) {
    <div class="mb-4 p-3 surface-ground border-round border-1 border-red-200 no-print">
      <div class="flex align-items-center gap-2 text-red-600 mb-2">
        <i class="pi pi-exclamation-triangle"></i>
        <span class="font-medium">Email Error</span>
      </div>
      <p class="text-sm text-color-secondary mb-3">{{ lastEmailError() }}</p>
      <div class="flex gap-2">
        <p-button
          label="Try Again"
          icon="pi pi-refresh"
          severity="info"
          size="small"
          (onClick)="onRetryEmail()"
          [disabled]="emailSending()"
          [loading]="emailSending()"
        />
        <p-button
          label="Dismiss"
          severity="secondary"
          [text]="true"
          size="small"
          (onClick)="dismissEmailError()"
        />
      </div>
    </div>
  }

  <!-- WhatsApp Phone Input (shown when no customer phone) -->
  @if (showWhatsAppInput()) {
    <div class="mb-4 p-3 surface-ground border-round no-print">
      <div class="flex flex-column gap-2">
        <label for="whatsappPhone" class="font-medium">
          <i class="pi pi-whatsapp text-green-500 mr-2"></i>
          Enter customer phone for WhatsApp
        </label>
        <div class="flex gap-2">
          <input
            pInputText
            id="whatsappPhone"
            [(ngModel)]="manualPhoneNumber"
            placeholder="+1234567890"
            class="flex-1"
            (keyup.enter)="onSendWhatsAppWithManualPhone()"
            [disabled]="pdfSharing()"
          />
          <p-button
            icon="pi pi-send"
            severity="success"
            (onClick)="onSendWhatsAppWithManualPhone()"
            [disabled]="!isManualPhoneValid() || pdfSharing()"
            [loading]="pdfSharing()"
            ariaLabel="Send to this number"
          />
          <p-button
            icon="pi pi-times"
            severity="secondary"
            [text]="true"
            (onClick)="hideWhatsAppInput()"
            [disabled]="pdfSharing()"
            ariaLabel="Cancel"
          />
        </div>
        @if (manualPhoneNumber && !isManualPhoneValid()) {
          <small class="text-red-500">Please enter a valid phone number (10-15 digits)</small>
        }
      </div>
    </div>
  }

  <!-- WhatsApp Error with Retry -->
  @if (lastWhatsAppError()) {
    <div class="mb-4 p-3 surface-ground border-round border-1 border-red-200 no-print">
      <div class="flex align-items-center gap-2 text-red-600 mb-2">
        <i class="pi pi-exclamation-triangle"></i>
        <span class="font-medium">WhatsApp Error</span>
      </div>
      <p class="text-sm text-color-secondary mb-3">{{ lastWhatsAppError() }}</p>
      @if (lastWhatsAppLink()) {
        <div class="flex gap-2">
          <p-button
            label="Try Again"
            icon="pi pi-refresh"
            severity="success"
            size="small"
            (onClick)="onRetryWhatsApp()"
          />
          <p-button
            label="Dismiss"
            severity="secondary"
            [text]="true"
            size="small"
            (onClick)="lastWhatsAppError.set(null); lastWhatsAppLink.set(null)"
          />
        </div>
      }
    </div>
  }

  <!-- Modern Receipt Preview -->
  @if (receiptData()) {
    <div class="receipt-container" #receiptEl>
      <!-- Header Section -->
      <div class="receipt-header-section">
        <div class="receipt-header-left">
          <div class="payment-badge" [class.payment-badge-partial]="receiptData()!.paymentStatus === 'partial_paid'">
            <span class="badge-dot"></span>
            {{ receiptData()!.paymentStatus === 'partial_paid' ? 'Partial Payment' : 'Payment Completed' }}
          </div>
          <h2 class="receipt-main-title">Sales Receipt</h2>
          <div class="receipt-meta">
            <div class="meta-item">
              <span class="meta-label">Date Issued</span>
              <span class="meta-value">{{ receiptData()!.transactionDate }}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Receipt Number</span>
              <span class="meta-value">#{{ receiptData()!.receiptNumber }}</span>
            </div>
          </div>
        </div>
        <div class="receipt-header-right">
          <div class="parties-grid">
            <div class="party-block">
              <p class="party-label">Bill From</p>
              <p class="party-name">{{ storeConfig.name }}</p>
              <p class="party-detail">{{ storeConfig.address }}</p>
              <p class="party-detail">Tel: {{ storeConfig.phone }}</p>
            </div>
            @if (receiptData()!.customerName || receiptData()!.customerPhone || receiptData()!.customerEmail) {
              <div class="party-block">
                <p class="party-label">Bill To</p>
                @if (receiptData()!.customerName) {
                  <p class="party-name">{{ receiptData()!.customerName }}</p>
                }
                @if (receiptData()!.customerPhone) {
                  <p class="party-detail">Tel: {{ receiptData()!.customerPhone }}</p>
                }
                @if (receiptData()!.customerEmail) {
                  <p class="party-detail">{{ receiptData()!.customerEmail }}</p>
                }
              </div>
            }
          </div>
        </div>
      </div>

      <!-- Items Table -->
      <div class="items-table-wrapper">
        <table class="items-table">
          <thead>
            <tr>
              <th class="th-description">Description</th>
              <th class="th-qty">QTY</th>
              <th class="th-price">Unit Price</th>
              <th class="th-total">Total</th>
            </tr>
          </thead>
          <tbody>
            @for (item of receiptData()!.items; track $index) {
              <tr>
                <td class="td-description">
                  <span class="item-name">{{ item.name }}</span>
                  @if (item.imei) {
                    <span class="item-sub">IMEI: {{ item.imei }}</span>
                  }
                </td>
                <td class="td-qty">{{ item.quantity }}</td>
                <td class="td-price">{{ item.unitPrice | number:'1.2-2' }}</td>
                <td class="td-total">{{ item.total | number:'1.2-2' }}</td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <!-- Spacer -->
      <div class="receipt-spacer"></div>

      <!-- Footer: Payment Method + Grand Total + Divider -->
      <div class="receipt-footer">
        <div class="receipt-footer-content">
          @if (receiptData()!.payments && receiptData()!.payments!.length > 0) {
            <div class="receipt-footer-payment">
              <p class="footer-payment-label">{{ receiptData()!.payments!.length > 1 ? 'Payments' : 'Payment Method' }}</p>
              @for (payment of receiptData()!.payments; track $index) {
                <div class="footer-payment-row">
                  <span class="footer-payment-method">{{ getPaymentMethodLabel(payment.method) }}</span>
                  <span class="footer-payment-amount">{{ payment.amount | number:'1.2-2' }}</span>
                </div>
                @if (payment.cashTendered && payment.cashTendered > payment.amount) {
                  <div class="footer-cash-details">
                    <span>Tendered: {{ payment.cashTendered | number:'1.2-2' }}</span>
                    <span>Change: {{ (payment.changeGiven ?? payment.cashTendered - payment.amount) | number:'1.2-2' }}</span>
                  </div>
                }
              }
            </div>
          }
          <div class="grand-total-block">
            <p class="grand-total-label">{{ receiptData()!.paymentStatus === 'partial_paid' ? 'Amount Paid' : 'Total Amount Paid' }}</p>
            <div class="grand-total-amount">
              <span class="grand-total-currency">PKR</span>
              <span class="grand-total-value">{{ getDisplayAmountPaid() | number:'1.2-2' }}</span>
            </div>
          </div>
          @if (receiptData()!.balance && receiptData()!.balance! > 0) {
            <div class="remaining-balance-block">
              <p class="remaining-balance-label">Remaining Balance</p>
              <div class="remaining-balance-amount">
                <span class="remaining-balance-currency">PKR</span>
                <span class="remaining-balance-value">{{ receiptData()!.balance | number:'1.2-2' }}</span>
              </div>
              <p class="remaining-balance-note">This amount is outstanding</p>
            </div>
          }
        </div>
        <div class="receipt-footer-divider"></div>
      </div>
    </div>
  }

  <ng-template pTemplate="footer">
    <div class="flex flex-column md:flex-row justify-content-between gap-2 no-print">
      <div class="flex gap-2">
        @if (hasCustomerEmail()) {
          <p-button
            label="Resend Email"
            icon="pi pi-envelope"
            severity="info"
            [outlined]="true"
            (onClick)="onResendEmail()"
            [loading]="emailSending()"
            pTooltip="Send receipt again to customer email"
            tooltipPosition="top"
            ariaLabel="Resend receipt via Email"
          />
        }
        @if (hasCustomerPhone()) {
          <p-button
            label="Resend WhatsApp"
            icon="pi pi-whatsapp"
            severity="success"
            [outlined]="true"
            (onClick)="onSharePdf()"
            [loading]="pdfSharing()"
            pTooltip="Download PDF and open WhatsApp"
            tooltipPosition="top"
            ariaLabel="Resend PDF via WhatsApp"
          />
        }
      </div>
      <div class="flex gap-2">
        <p-button
          label="Close"
          severity="secondary"
          [text]="true"
          (onClick)="onClose()"
          ariaLabel="Close receipt dialog"
        />
        <p-button
          label="PDF"
          icon="pi pi-file-pdf"
          severity="secondary"
          (onClick)="onDownloadPdf()"
          ariaLabel="Download receipt as PDF"
        />
        <p-button
          label="Print"
          icon="pi pi-print"
          (onClick)="onPrint()"
          ariaLabel="Print receipt"
        />
      </div>
    </div>
  </ng-template>
</p-dialog>
