<div class="grid" role="main" aria-label="Dashboard">
  <!-- Header with Date Range Selector -->
  <div class="col-12 flex flex-column gap-3 mb-4">
    <div class="flex flex-column sm:flex-row sm:align-items-center sm:justify-content-between gap-3">
      <h1 class="text-3xl font-bold m-0">Dashboard</h1>
      <p-button
        icon="pi pi-refresh"
        label="Refresh"
        [outlined]="true"
        severity="secondary"
        (onClick)="loadAll()"
        [loading]="loading()"
        styleClass="w-full sm:w-auto"
        ariaLabel="Refresh dashboard data"
      />
    </div>
    <div class="flex flex-column sm:flex-row align-items-start sm:align-items-center gap-3" role="group" aria-label="Date range filter">
      <div class="flex align-items-center gap-2">
        <i class="pi pi-calendar text-color-secondary" aria-hidden="true"></i>
        <span class="text-color-secondary font-medium" id="period-label">Period:</span>
      </div>
      <p-select
        [options]="dateRangeOptions"
        [(ngModel)]="selectedDateRange"
        optionLabel="label"
        optionValue="value"
        (onChange)="onDateRangeChange()"
        styleClass="w-full sm:w-14rem"
        ariaLabelledBy="period-label"
      />
      @if (selectedDateRange === customRangeValue) {
        <p-datepicker
          [(ngModel)]="customStartDate"
          [showIcon]="true"
          [maxDate]="customEndDate || today"
          dateFormat="yy-mm-dd"
          placeholder="Start date"
          (onSelect)="onCustomDateChange()"
          styleClass="w-full sm:w-auto"
          inputStyleClass="w-full sm:w-10rem"
          ariaLabel="Custom start date"
        />
        <span class="text-color-secondary font-medium" aria-hidden="true">to</span>
        <p-datepicker
          [(ngModel)]="customEndDate"
          [showIcon]="true"
          [minDate]="customStartDate!"
          [maxDate]="today"
          dateFormat="yy-mm-dd"
          placeholder="End date"
          (onSelect)="onCustomDateChange()"
          styleClass="w-full sm:w-auto"
          inputStyleClass="w-full sm:w-10rem"
          ariaLabel="Custom end date"
        />
      }
      @if (activeDateRangeLabel()) {
        <span class="text-sm text-color-secondary" aria-live="polite">{{ activeDateRangeLabel() }}</span>
      }
    </div>
  </div>

  <!-- Shop Details Setup Prompt -->
  @if (shopDetailsService.loaded() && !shopDetailsConfigured()) {
    <div class="col-12">
      <div class="flex align-items-center gap-3 p-3 border-round surface-warning border-1 border-yellow-500">
        <i class="pi pi-exclamation-triangle text-yellow-500 text-2xl" aria-hidden="true"></i>
        <div class="flex-1">
          <span class="font-semibold text-color">Shop Details Not Configured</span>
          <span class="text-color-secondary text-sm block mt-1">
            Configure your business name, contact info, hours, and more to display on the public website.
          </span>
        </div>
        <p-button
          label="Configure Now"
          icon="pi pi-cog"
          size="small"
          severity="warn"
          (onClick)="navigateToShopDetails()"
          ariaLabel="Configure shop details"
        />
      </div>
    </div>
  }

  <!-- Quick Actions -->
  <div class="col-12">
    <div class="flex flex-column sm:flex-row gap-3">
      <p-button
        label="Create New Sale"
        icon="pi pi-shopping-cart"
        styleClass="flex-1"
        severity="success"
        size="large"
        (onClick)="navigateToNewSale()"
      />
      <p-button
        label="Add Inventory"
        icon="pi pi-plus"
        styleClass="flex-1"
        severity="primary"
        size="large"
        (onClick)="navigateToAddProduct()"
      />
    </div>
  </div>

  <!-- Stock Alerts (above KPI cards) -->
  <div class="col-12">
    <app-stock-alerts-panel
      [alerts]="stockAlerts()"
      [config]="stockAlertConfig()"
      [loading]="alertsLoading()"
      (configureClicked)="showAlertConfig = true"
    />
  </div>

  <!-- Stock Alert Config Dialog -->
  <app-stock-alert-config-dialog
    [visible]="showAlertConfig"
    [config]="stockAlertConfig()"
    (visibleChange)="showAlertConfig = $event"
    (configSaved)="onAlertConfigSaved()"
  />

  <!-- KPI Cards Section -->
  <section class="col-12" aria-label="Key Performance Indicators">
    <div class="grid">
      <!-- Total Stock -->
      <div class="col-12 md:col-6 xl:col-3">
        <p-card styleClass="h-full">
          @if (loading()) {
            <div class="flex align-items-center gap-3" aria-busy="true" aria-label="Loading total stock">
              <p-skeleton shape="circle" size="3rem" />
              <div class="flex-1">
                <p-skeleton width="60%" styleClass="mb-2" />
                <p-skeleton width="40%" height="1.75rem" />
              </div>
            </div>
          } @else {
            <div class="flex align-items-center gap-3" role="article" aria-label="Total Stock: {{ kpis().stockCount }} products available">
              <div class="w-3rem h-3rem border-round bg-blue-100 flex align-items-center justify-content-center flex-shrink-0">
                <i class="pi pi-mobile text-blue-500 text-2xl" aria-hidden="true"></i>
              </div>
              <div>
                <span class="text-color-secondary text-sm block mb-1">Total Stock</span>
                <span class="text-2xl font-bold text-color">{{ kpis().stockCount }}</span>
              </div>
            </div>
          }
        </p-card>
      </div>

      <!-- Stock Value -->
      <div class="col-12 md:col-6 xl:col-3">
        <p-card styleClass="h-full">
          @if (loading()) {
            <div class="flex align-items-center gap-3" aria-busy="true" aria-label="Loading stock value">
              <p-skeleton shape="circle" size="3rem" />
              <div class="flex-1">
                <p-skeleton width="60%" styleClass="mb-2" />
                <p-skeleton width="40%" height="1.75rem" />
              </div>
            </div>
          } @else {
            <div class="flex align-items-center gap-3" role="article" aria-label="Stock Value: {{ kpis().stockValue | appCurrency }}">
              <div class="w-3rem h-3rem border-round bg-green-100 flex align-items-center justify-content-center flex-shrink-0">
                <i class="pi pi-dollar text-green-500 text-2xl" aria-hidden="true"></i>
              </div>
              <div>
                <span class="text-color-secondary text-sm block mb-1">Stock Value</span>
                <span class="text-2xl font-bold text-color">{{ kpis().stockValue | appCurrency }}</span>
              </div>
            </div>
          }
        </p-card>
      </div>

      <!-- Potential Profit -->
      <div class="col-12 md:col-6 xl:col-3">
        <p-card styleClass="h-full">
          @if (loading()) {
            <div class="flex align-items-center gap-3" aria-busy="true" aria-label="Loading potential profit">
              <p-skeleton shape="circle" size="3rem" />
              <div class="flex-1">
                <p-skeleton width="60%" styleClass="mb-2" />
                <p-skeleton width="40%" height="1.75rem" />
              </div>
            </div>
          } @else {
            <div class="flex align-items-center gap-3" role="article" aria-label="Potential Profit: {{ kpis().potentialProfit | appCurrency }}">
              <div class="w-3rem h-3rem border-round bg-purple-100 flex align-items-center justify-content-center flex-shrink-0">
                <i class="pi pi-trending-up text-purple-500 text-2xl" aria-hidden="true"></i>
              </div>
              <div>
                <span class="text-color-secondary text-sm block mb-1">Potential Profit</span>
                <span class="text-2xl font-bold text-color">{{ kpis().potentialProfit | appCurrency }}</span>
              </div>
            </div>
          }
        </p-card>
      </div>

      <!-- Total Sales -->
      <div class="col-12 md:col-6 xl:col-3">
        <p-card styleClass="h-full">
          @if (loading()) {
            <div class="flex align-items-center gap-3" aria-busy="true" aria-label="Loading total sales">
              <p-skeleton shape="circle" size="3rem" />
              <div class="flex-1">
                <p-skeleton width="60%" styleClass="mb-2" />
                <p-skeleton width="40%" height="1.75rem" />
              </div>
            </div>
          } @else {
            <div class="flex align-items-center gap-3" role="article" aria-label="Total Sales: {{ kpis().totalSales }} sales completed">
              <div class="w-3rem h-3rem border-round bg-orange-100 flex align-items-center justify-content-center flex-shrink-0">
                <i class="pi pi-shopping-cart text-orange-500 text-2xl" aria-hidden="true"></i>
              </div>
              <div>
                <span class="text-color-secondary text-sm block mb-1">Total Sales</span>
                <span class="text-2xl font-bold text-color">{{ kpis().totalSales }}</span>
              </div>
            </div>
          }
        </p-card>
      </div>
    </div>
  </section>

  <!-- Charts Section -->
  <section class="col-12" aria-label="Charts and Analytics">
    <div class="grid">
      <!-- Sales Revenue Bar Chart -->
      <div class="col-12 lg:col-7">
        <p-card>
          <ng-template #header>
            <div class="flex align-items-center justify-content-between px-3 pt-3">
              <h2 class="text-xl font-semibold text-color m-0">Sales Revenue</h2>
              <i class="pi pi-chart-bar text-color-secondary text-xl" aria-hidden="true"></i>
            </div>
          </ng-template>
          @if (chartsLoading()) {
            <div class="flex align-items-center justify-content-center" style="height: 300px" aria-busy="true" aria-label="Loading sales chart">
              <p-skeleton width="100%" height="300px" />
            </div>
          } @else if (hasSalesData()) {
            <div role="img" aria-label="Bar chart showing monthly sales revenue">
              <p-chart
                type="bar"
                [data]="salesChartData()"
                [options]="salesChartOptions()"
                [responsive]="true"
                height="300px"
              />
            </div>
          } @else {
            <div class="flex flex-column align-items-center justify-content-center text-color-secondary" style="height: 300px" role="status">
              <i class="pi pi-chart-bar text-4xl mb-3" aria-hidden="true"></i>
              <span class="text-lg">No sales data available for the selected period</span>
              <span class="text-sm mt-1">Sales will appear here once transactions are recorded</span>
            </div>
          }
        </p-card>
      </div>

      <!-- Stock by Brand Doughnut Chart -->
      <div class="col-12 lg:col-5">
        <p-card>
          <ng-template #header>
            <div class="flex align-items-center justify-content-between px-3 pt-3">
              <h2 class="text-xl font-semibold text-color m-0">Stock by Brand</h2>
              <i class="pi pi-chart-pie text-color-secondary text-xl" aria-hidden="true"></i>
            </div>
          </ng-template>
          @if (chartsLoading()) {
            <div class="flex align-items-center justify-content-center" style="height: 300px" aria-busy="true" aria-label="Loading stock chart">
              <p-skeleton width="100%" height="300px" />
            </div>
          } @else if (hasStockData()) {
            <div role="img" aria-label="Doughnut chart showing stock distribution by brand">
              <p-chart
                type="doughnut"
                [data]="stockChartData()"
                [options]="stockChartOptions()"
                [responsive]="true"
                height="300px"
              />
            </div>
          } @else {
            <div class="flex flex-column align-items-center justify-content-center text-color-secondary" style="height: 300px" role="status">
              <i class="pi pi-chart-pie text-4xl mb-3" aria-hidden="true"></i>
              <span class="text-lg">No stock data available</span>
              <span class="text-sm mt-1">Inventory will appear here once products are added</span>
            </div>
          }
        </p-card>
      </div>
    </div>
  </section>

  <!-- Recently Added Products Section -->
  <section class="col-12" aria-label="Recently added products">
    <p-card>
      <ng-template #header>
        <div class="flex align-items-center justify-content-between px-3 pt-3">
          <h2 class="text-xl font-semibold text-color m-0">Recently Added</h2>
          <p-button
            icon="pi pi-list"
            label="View All"
            [text]="true"
            severity="secondary"
            size="small"
            (onClick)="navigateToInventory()"
            ariaLabel="View all inventory"
          />
        </div>
      </ng-template>
      @if (loading()) {
        <div class="flex flex-column gap-3" aria-busy="true" aria-label="Loading recently added products">
          @for (_ of skeletonRows; track $index) {
            <div class="flex align-items-center gap-3">
              <p-skeleton width="15%" />
              <p-skeleton width="20%" />
              <p-skeleton width="15%" />
              <p-skeleton width="15%" />
              <p-skeleton width="20%" />
            </div>
          }
        </div>
      } @else if (recentProducts().length > 0) {
        <p-table
          [value]="recentProducts()"
          [rowHover]="true"
          (onRowSelect)="onRecentProductClick($any($event).data)"
          selectionMode="single"
          dataKey="id"
          [scrollable]="true"
          scrollDirection="horizontal"
          [tableStyle]="{ 'min-width': '40rem' }"
          ariaLabel="Recently added products table"
        >
          <ng-template #header>
            <tr>
              <th scope="col">Brand</th>
              <th scope="col">Model</th>
              <th scope="col">Condition</th>
              <th scope="col">Selling Price</th>
              <th scope="col">Date Added</th>
              <th scope="col" class="w-3rem"></th>
            </tr>
          </ng-template>
          <ng-template #body let-product>
            <tr [pSelectableRow]="product" class="cursor-pointer" role="button" tabindex="0" [attr.aria-label]="'Edit ' + product.brandName + ' ' + product.model">
              <td>{{ product.brandName }}</td>
              <td class="font-medium">{{ product.model }}</td>
              <td>
                <p-tag
                  [value]="product.condition | titlecase"
                  [severity]="getConditionSeverity(product.condition)"
                />
              </td>
              <td>{{ product.sellingPrice | appCurrency:'1.2-2' }}</td>
              <td>{{ product.createdAt | date:'mediumDate' }}</td>
              <td class="text-right">
                <i class="pi pi-pencil text-color-secondary text-sm" aria-hidden="true"></i>
              </td>
            </tr>
          </ng-template>
        </p-table>
      } @else {
        <div class="flex flex-column align-items-center justify-content-center text-color-secondary py-5" role="status">
          <i class="pi pi-inbox text-4xl mb-3" aria-hidden="true"></i>
          <span class="text-lg">No products added yet</span>
          <span class="text-sm mt-1 mb-3">Recently added products will appear here</span>
          <p-button
            icon="pi pi-plus"
            label="Add Product"
            [outlined]="true"
            (onClick)="navigateToAddProduct()"
            ariaLabel="Add new product to inventory"
          />
        </div>
      }
    </p-card>
  </section>
</div>
